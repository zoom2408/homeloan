<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Loan Lab (Previewable)</title>
  <!--
    Single-file, previewable (open index.html in browser)

    Features implemented from this chat:
    - Amortized loan with monthly payments
    - Fixed period then floating rate (manual rate schedule bands)
    - Grace period: interest-only or full; optional capitalization for full-grace
    - Floating rate editable: just type your own rate in bands
    - Toggle to flag ‚Äúpayment jumps‚Äù when rate changes (+ threshold)
    - Charts: Balance over time, Interest paid per year
    - Scenario A/B comparison: two independent Rate Schedule tables; select A/B via dropdown
    - Draggable dashboard sections + collapsible sections; layout persisted in localStorage
    - Export repayment table to CSV

    Notes:
    - Rates are decimals (0.105 = 10.5% annually)
    - Re-amortizes each month based on current rate and remaining term
  -->

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ color-scheme: light; }
    /* little fintech sparkle */
    .bg-fintech{
      background:
        radial-gradient(900px 500px at 20% 0, rgba(217,70,239,.18), transparent 55%),
        radial-gradient(900px 500px at 80% 0, rgba(99,102,241,.20), transparent 55%),
        linear-gradient(to bottom, #f8fafc, white);
    }
    .card-glass{ background: rgba(255,255,255,.80); backdrop-filter: blur(10px); }
    .handle{ touch-action:none; }
    .dragging{ opacity:.65; }
    .drop-hint{ outline: 2px solid rgba(217,70,239,.35); outline-offset: 2px; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display:none; }
    .tabular{ font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-fintech text-slate-900 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="mb-6 rounded-[28px] border border-slate-200 card-glass shadow-sm">
      <div class="p-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <div class="inline-flex items-center gap-2">
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-gradient-to-tr from-fuchsia-600 to-indigo-600 text-white shadow">üè†</span>
            <h1 class="text-2xl font-extrabold tracking-tight">Home Loan Lab</h1>
          </div>
          <p class="mt-2 max-w-2xl text-sm text-slate-600">
            Drag sections to rearrange your dashboard. Collapse what you don‚Äôt need. Rates are manual bands (Scenario A/B).
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <span id="pillRows" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Rows: ‚Äî</span>
          <span id="pillCovered" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Covered: ‚Äî</span>
          <span id="pillJumps" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-emerald-100 text-emerald-900 ring-emerald-200">Jumps: ‚Äî</span>
          <button id="resetLayoutBtn" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50">
            Reset layout
          </button>
          <div class="relative">
            <button id="sectionMenuBtn" class="grid h-10 w-10 place-items-center rounded-2xl border border-slate-200 bg-white text-slate-700 shadow-sm transition hover:bg-slate-50" title="Show sections menu" aria-haspopup="true" aria-expanded="false">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M4 7.5h16M4 12h16M4 16.5h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
            <div id="sectionMenu" class="absolute right-0 z-20 mt-2 w-72 rounded-2xl border border-slate-200 bg-white shadow-lg hidden">
              <div class="border-b border-slate-100 px-4 py-3 text-left">
                <div class="text-sm font-extrabold text-slate-900">Sections</div>
                <div class="text-xs text-slate-500">Default sections stay on. Toggle the rest.</div>
              </div>
              <div id="sectionMenuList" class="p-3 flex flex-col gap-2 text-sm text-slate-800"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="coverageWarning" class="hidden px-6 pb-6">
        <div class="rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-800">
          Selected schedule (<b id="warnScenario">A</b>) doesn‚Äôt cover month <b id="warnMonth">‚Äî</b> onward. Add a band.
        </div>
      </div>
    </div>

    <!-- Board (draggable sections) -->
    <div id="board" class="grid grid-cols-1 gap-4"></div>

    <div class="mt-8 text-center text-xs text-slate-500">This calculator is for estimation only.</div>
  </div>

<script>
  // -----------------------
  // Utilities
  // -----------------------
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
  const toISODate = (d) => {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };
  const addMonthsISO = (startISO, monthsToAdd) => {
    const [y, m, d] = startISO.split("-").map(x => parseInt(x, 10));
    const dt = new Date(y, m - 1, d);
    dt.setMonth(dt.getMonth() + monthsToAdd);
    return toISODate(dt);
  };

  const pmt = (ratePerPeriod, nPeriods, presentValue) => {
    if (nPeriods <= 0) return 0;
    if (Math.abs(ratePerPeriod) < 1e-12) return presentValue / nPeriods;
    const r = ratePerPeriod;
    const pow = Math.pow(1 + r, nPeriods);
    return (presentValue * r * pow) / (pow - 1);
  };

  const normalizeSchedule = (schedule) => {
    return [...schedule]
      .map(b => ({
        startMonth: Math.max(1, Math.floor(b.startMonth || 1)),
        endMonth: Math.max(1, Math.floor(b.endMonth || 1)),
        annualRate: Number.isFinite(b.annualRate) ? b.annualRate : 0,
      }))
      .sort((a,b) => a.startMonth - b.startMonth);
  };

  const getAnnualRateForMonth = (schedule, month) => {
    for (const band of schedule) {
      if (month >= band.startMonth && month <= band.endMonth) return band.annualRate;
    }
    return null;
  };

  const formatPct = (x) => Number.isFinite(x) ? `${(x*100).toFixed(3)}%` : "";

  // Number formatting for inputs: comma thousands + dot decimals (force en-US style)
  const formatNumberInput = (n, maxDecimals = 2) => {
    if (!Number.isFinite(n)) return "";
    const dec = Math.max(0, Math.min(12, maxDecimals));
    return new Intl.NumberFormat("en-US", {
      useGrouping: true,
      maximumFractionDigits: dec,
    }).format(n);
  };

  const parseNumberInput = (s) => {
    if (s == null) return 0;
    const cleaned = String(s)
      .trim()
      .replace(/,/g, "")
      .replace(/[^0-9.\-]/g, "");
    if (cleaned === "" || cleaned === "-" || cleaned === ".") return 0;
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  };

  const makeMoneyFormatter = (currency, customCode) => {
    const code = currency === "CUSTOM" ? (customCode || "USD") : currency;
    return (n) => {
      if (!Number.isFinite(n)) return "";
      try {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: code,
          maximumFractionDigits: code === "VND" ? 0 : 2,
        }).format(n);
      } catch {
        return new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(n);
      }
    };
  };

  const summarize = (rows) => {
    const totalInterest = rows.reduce((s,r) => s + r.interest, 0);
    const totalPaid = rows.reduce((s,r) => s + r.payment + r.extra, 0);
    const maxPayment = rows.reduce((m,r) => Math.max(m, r.payment), 0);
    const payoffDate = rows.length ? rows[rows.length-1].dateISO : "";
    const rateChangeCount = rows.filter(r => r.rateChanged).length;
    return { totalInterest, totalPaid, maxPayment, payoffDate, rateChangeCount };
  };

  const yearlyInterest = (rows) => {
    const map = new Map();
    for (const r of rows) {
      const y = parseInt(r.dateISO.slice(0,4), 10);
      map.set(y, (map.get(y) || 0) + r.interest);
    }
    return Array.from(map.entries())
      .sort((a,b)=>a[0]-b[0])
      .map(([year, interest]) => ({ year, interest }));
  };

  const balanceSeries = (rows) => rows.map(r => ({ date: r.dateISO, balance: r.endBalance }));

  const buildAmortization = (inputs, schedule) => {
    const sched = normalizeSchedule(schedule);
    const nTotal = getTermPeriods(inputs);
    const ppY = inputs.paymentsPerYear;
    const graceMonths = inputs.graceEnabled ? Math.max(0, Math.floor(inputs.graceMonths)) : 0;

    const rows = [];
    let bal = inputs.principal;
    let missingCoverageFromMonth = null;

    for (let period = 1; period <= nTotal; period++) {
      const annualRate = getAnnualRateForMonth(sched, period);
      if (annualRate == null) { missingCoverageFromMonth = period; break; }

      const monthlyRate = annualRate / ppY;
      const begin = bal;
      const dateISO = addMonthsISO(inputs.startDateISO, period - 1);

      const inGrace = inputs.graceEnabled && period <= graceMonths;
      const note = inGrace ? `Grace: ${inputs.graceType}` : "";

      const interest = begin * monthlyRate;

      let payment = 0;
      if (begin <= 0) {
        payment = 0;
      } else if (inGrace) {
        payment = inputs.graceType === "full" ? 0 : interest;
      } else {
        const remaining = nTotal - period + 1;
        payment = pmt(monthlyRate, remaining, begin);
        payment = Math.min(payment, begin + interest);
      }

      const principalPaid = Math.max(0, payment - interest);

      const extra =
        begin <= 0 ? 0 : (inGrace ? 0 : Math.min(Math.max(0, inputs.extraPaymentMonthly), Math.max(0, begin - principalPaid)));

      let end = begin - principalPaid - extra;

      if (inGrace && inputs.graceType === "full" && inputs.capitalizeFullGraceInterest) {
        end = begin + interest;
      }

      end = Math.max(0, end);

      const prev = rows[rows.length - 1];
      const rateChanged = prev ? Math.abs(prev.annualRate - annualRate) > 1e-12 : false;
      const paymentJump = prev ? (payment - prev.payment) : 0;

      rows.push({
        period,
        dateISO,
        annualRate,
        monthlyRate,
        beginBalance: begin,
        payment,
        interest,
        principal: principalPaid,
        extra,
        endBalance: end,
        rateChanged,
        paymentJump,
        note,
      });

      bal = end;
      if (bal <= 0) break;
    }

    return { rows, nTotal, missingCoverageFromMonth };
  };

  const downloadCSV = (filename, rows) => {
    const headers = [
      "Period","Date","AnnualRate","BeginBalance","Payment","Interest","Principal","Extra","EndBalance","RateChanged","PaymentJump","Note"
    ];
    const lines = [headers.join(",")];
    for (const r of rows) {
      lines.push([
        r.period,
        r.dateISO,
        r.annualRate,
        r.beginBalance,
        r.payment,
        r.interest,
        r.principal,
        r.extra,
        r.endBalance,
        r.rateChanged,
        r.paymentJump,
        JSON.stringify(r.note || ""),
      ].join(","));
    }
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // -----------------------
  // State
  // -----------------------
  const state = {
    inputs: {
      principal: 2_000_000_000,
      startDateISO: "2026-01-01",
      termUnit: "years", // years | months
      termValue: 20,
      paymentsPerYear: 12,
      extraPaymentMonthly: 0,

      graceEnabled: false,
      graceType: "interest_only", // interest_only | full
      graceMonths: 0,
      capitalizeFullGraceInterest: false,

      scenario: "A", // A | B

      showPaymentJumps: true,
      jumpThreshold: 500_000,

      currency: "VND", // VND | USD | EUR | CUSTOM
      customCurrencyCode: "USD",
    },
    scheduleA: [
      { startMonth: 1, endMonth: 24, annualRate: 0.085 },
      { startMonth: 25, endMonth: 240, annualRate: 0.105 },
    ],
    scheduleB: [
      { startMonth: 1, endMonth: 24, annualRate: 0.085 },
      { startMonth: 25, endMonth: 60, annualRate: 0.11 },
      { startMonth: 61, endMonth: 240, annualRate: 0.102 },
    ],
  };

  // -----------------------
  // Draggable + Collapsible sections (native DnD)
  // -----------------------
  const LS_ORDER = "hl_html_order_v2";
  const LS_COLLAPSED = "hl_html_collapsed_v2";
  const LS_VISIBLE = "hl_html_visible_v1";

  const DEFAULT_ORDER = ["inputs","grace","metrics","charts","compare","scheduleA","scheduleB","table"];
  const ALWAYS_VISIBLE = ["inputs","grace","metrics","table"];
  const DEFAULT_VISIBLE = {
    inputs: true,
    grace: true,
    metrics: true,
    table: true,
    charts: false,
    compare: false,
    scheduleA: false,
    scheduleB: false,
  };

  const sectionMeta = {
    inputs:   { title: "Inputs",           subtitle: "Loan basics + scenario + currency" },
    grace:    { title: "Grace & Jump rules", subtitle: "Grace period + jump threshold" },
    metrics:  { title: "Key metrics",      subtitle: "Selected scenario summary" },
    charts:   { title: "Charts",           subtitle: "Balance + interest per year" },
    compare:  { title: "Scenario A/B",     subtitle: "Same inputs, different schedules" },
    scheduleA:{ title: "Rate Schedule A",  subtitle: "Manual bands" },
    scheduleB:{ title: "Rate Schedule B",  subtitle: "Manual bands" },
    table:    { title: "Repayment table",  subtitle: "Full amortization list" },
  };

  function loadLayout(){
    let order = DEFAULT_ORDER;
    let collapsed = {
      inputs:false, grace:false, metrics:false, charts:false, compare:false, scheduleA:true, scheduleB:true, table:false
    };
    try {
      const rawOrder = JSON.parse(localStorage.getItem(LS_ORDER) || "null");
      if (Array.isArray(rawOrder)) {
        const known = new Set(DEFAULT_ORDER);
        const cleaned = rawOrder.filter(id => known.has(id));
        DEFAULT_ORDER.forEach(id => { if(!cleaned.includes(id)) cleaned.push(id); });
        order = cleaned;
      }
      const rawCol = JSON.parse(localStorage.getItem(LS_COLLAPSED) || "null");
      if (rawCol && typeof rawCol === "object") {
        collapsed = { ...collapsed, ...rawCol };
      }
    } catch {}
    return { order, collapsed };
  }

  function loadVisibility(){
    let visible = { ...DEFAULT_VISIBLE };
    try {
      const raw = JSON.parse(localStorage.getItem(LS_VISIBLE) || "null");
      if (raw && typeof raw === "object") {
        Object.entries(raw).forEach(([k,v]) => {
          if (DEFAULT_VISIBLE.hasOwnProperty(k)) visible[k] = !!v;
        });
      }
    } catch {}
    ALWAYS_VISIBLE.forEach(k => visible[k] = true);
    return visible;
  }

  function saveLayout(order, collapsed){
    try {
      localStorage.setItem(LS_ORDER, JSON.stringify(order));
      localStorage.setItem(LS_COLLAPSED, JSON.stringify(collapsed));
    } catch {}
  }

  function saveVisibility(visible){
    try {
      localStorage.setItem(LS_VISIBLE, JSON.stringify(visible));
    } catch {}
  }

  let layout = loadLayout();
  let visibility = loadVisibility();

  // -----------------------
  // Rendering
  // -----------------------
  const board = document.getElementById("board");
  const sectionMenu = document.getElementById("sectionMenu");
  const sectionMenuBtn = document.getElementById("sectionMenuBtn");
  const sectionMenuList = document.getElementById("sectionMenuList");

  let charts = { balance: null, interest: null };

  function renderSectionMenu(){
    if (!sectionMenuList) return;
    sectionMenuList.innerHTML = "";

    const addRow = (label, controlHTML) => {
      const row = document.createElement("div");
      row.className = "flex items-center justify-between gap-3 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2";
      row.innerHTML = `<span class="text-sm font-semibold text-slate-800">${label}</span>${controlHTML}`;
      sectionMenuList.appendChild(row);
    };

    ALWAYS_VISIBLE.forEach(id => {
      const meta = sectionMeta[id];
      addRow(meta.title, `<span class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Default</span>`);
    });

    const toggleables = DEFAULT_ORDER.filter(id => !ALWAYS_VISIBLE.includes(id));
    toggleables.forEach(id => {
      const meta = sectionMeta[id];
      const wrap = document.createElement("label");
      wrap.className = "flex items-center justify-between gap-3 rounded-xl border border-slate-100 px-3 py-2 hover:bg-slate-50 cursor-pointer";
      const input = document.createElement("input");
      input.type = "checkbox";
      input.className = "h-4 w-4 rounded border-slate-300 text-fuchsia-600 focus:ring-fuchsia-200";
      input.checked = !!visibility[id];
      input.addEventListener("change", () => {
        visibility[id] = !!input.checked;
        saveVisibility(visibility);
        render();
      });
      const labelEl = document.createElement("div");
      labelEl.className = "flex flex-col";
      labelEl.innerHTML = `<span class="text-sm font-semibold text-slate-800">${meta.title}</span><span class="text-[11px] text-slate-500">${meta.subtitle}</span>`;
      wrap.appendChild(labelEl);
      wrap.appendChild(input);
      sectionMenuList.appendChild(wrap);
    });
  }

  let menuOpen = false;
  function setMenu(open){
    if (!sectionMenu || !sectionMenuBtn) return;
    menuOpen = !!open;
    sectionMenu.classList.toggle("hidden", !menuOpen);
    sectionMenuBtn.setAttribute("aria-expanded", menuOpen ? "true" : "false");
  }

  if (sectionMenuBtn){
    sectionMenuBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      setMenu(!menuOpen);
    });
  }

  document.addEventListener("click", (e)=>{
    if (!menuOpen) return;
    if (sectionMenu && sectionMenu.contains(e.target)) return;
    if (sectionMenuBtn && sectionMenuBtn.contains(e.target)) return;
    setMenu(false);
  });

  function pill(el, tone){
    const map = {
      slate:   "bg-slate-100 text-slate-700 ring-slate-200",
      indigo:  "bg-indigo-100 text-indigo-800 ring-indigo-200",
      amber:   "bg-amber-100 text-amber-900 ring-amber-200",
      green:   "bg-emerald-100 text-emerald-900 ring-emerald-200",
      rose:    "bg-rose-100 text-rose-900 ring-rose-200",
      cyan:    "bg-cyan-100 text-cyan-900 ring-cyan-200",
    };
    el.className = "inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 " + (map[tone] || map.slate);
  }

  function sectionShell(id, innerHTML, rightHTML=""){
    const meta = sectionMeta[id];
    const isCollapsed = !!layout.collapsed[id];

    const wrap = document.createElement("div");
    wrap.className = "";
    wrap.dataset.id = id;

    wrap.innerHTML = `
      <div class="rounded-3xl border border-slate-200 card-glass shadow-sm overflow-hidden">
        <div class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-100 px-5 py-4">
          <div class="flex items-center gap-3">
            <button class="handle grid h-9 w-9 place-items-center rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 cursor-grab active:cursor-grabbing select-none" draggable="true" title="Drag to reorder">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-slate-500">
                <path d="M10 4H4v6h6V4Zm10 0h-6v6h6V4ZM10 14H4v6h6v-6Zm10 0h-6v6h6v-6Z" fill="currentColor" opacity=".75" />
              </svg>
            </button>
            <div>
              <div class="flex items-center gap-2">
                <div class="text-sm font-extrabold tracking-tight text-slate-900">${meta.title}</div>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-fuchsia-700">
                  <path d="M12 2l1.6 5.2L19 9l-5.4 1.8L12 16l-1.6-5.2L5 9l5.4-1.8L12 2Z" fill="currentColor" opacity=".85" />
                </svg>
              </div>
              <div class="text-xs text-slate-500">${meta.subtitle}</div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            ${rightHTML}
            <button class="toggle rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-bold text-slate-700 hover:bg-slate-50">
              <span class="inline-flex items-center gap-2">
                <span class="label">${isCollapsed ? "Expand" : "Collapse"}</span>
                <span class="chev transition-transform ${isCollapsed ? "rotate-180" : "rotate-0"}">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-slate-600">
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </span>
              </span>
            </button>
          </div>
        </div>

        <div class="body px-5 py-4 ${isCollapsed ? "hidden" : ""}">
          ${innerHTML}
        </div>
      </div>
    `;

    // toggle collapse
    wrap.querySelector(".toggle").addEventListener("click", () => {
      layout.collapsed[id] = !layout.collapsed[id];
      saveLayout(layout.order, layout.collapsed);
      render();
    });

    return wrap;
  }

  function inputField(label, hint, inputHTML){
    return `
      <div class="flex flex-col gap-1">
        <div class="flex items-center justify-between">
          <div class="text-xs font-semibold text-slate-700">${label}</div>
          ${hint ? `<div class="text-[11px] text-slate-400">${hint}</div>` : ""}
        </div>
        ${inputHTML}
      </div>
    `;
  }

  function textInput(id, type="text", step="", min="", placeholder=""){
    const stepAttr = step !== "" ? `step="${step}"` : "";
    const minAttr = min !== "" ? `min="${min}"` : "";
    const phAttr = placeholder ? `placeholder="${placeholder}"` : "";
    return `<input id="${id}" type="${type}" ${stepAttr} ${minAttr} ${phAttr}
      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none placeholder:text-slate-400 focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />`;
  }

  // Term input: number + unit dropdown (years/months)
  function termInput(valueId, unitId){
    return `
      <div class="flex items-stretch overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm focus-within:ring-2 focus-within:ring-fuchsia-100 focus-within:border-fuchsia-300">
        <input id="${valueId}" type="number" min="1"
          class="h-10 w-full bg-transparent px-3 text-sm text-slate-900 outline-none" />
        <div class="border-l border-slate-200 bg-slate-50 px-2 flex items-center">
          <select id="${unitId}" class="h-8 rounded-xl border border-slate-200 bg-white px-2 text-xs font-extrabold text-slate-700 outline-none focus:ring-2 focus:ring-fuchsia-100">
            <option value="years">Years (max 30)</option>
            <option value="months">Months (max 360)</option>
          </select>
        </div>
      </div>
    `;
  }

  const getTermPeriods = (inputs) => {
    const ppY = inputs.paymentsPerYear;
    if (inputs.termUnit === "months") return clamp(Math.floor(inputs.termValue || 1), 1, 360);
    const years = clamp(Number(inputs.termValue || 1), 1, 30);
    return Math.min(Math.floor(years * ppY), 360);
  };


  // Money input: text field (formatted) + currency dropdown suffix
  function moneyInput(id, currencySelectId, customCodeId){
    return `
      <div class="flex items-stretch overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm focus-within:ring-2 focus-within:ring-fuchsia-100 focus-within:border-fuchsia-300">
        <input id="${id}" inputmode="decimal" autocomplete="off" spellcheck="false"
          class="h-10 w-full bg-transparent px-3 text-sm text-slate-900 outline-none placeholder:text-slate-400" />
        <div class="flex items-center gap-2 border-l border-slate-200 bg-slate-50 px-2">
          <select id="${currencySelectId}" class="h-8 rounded-xl border border-slate-200 bg-white px-2 text-xs font-extrabold text-slate-700 outline-none focus:ring-2 focus:ring-fuchsia-100">
            <option value="VND">VND</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="CUSTOM">Custom</option>
          </select>
          <input id="${customCodeId}" class="h-8 w-20 rounded-xl border border-slate-200 bg-white px-2 text-xs font-extrabold text-slate-700 outline-none focus:ring-2 focus:ring-fuchsia-100" placeholder="USD" />
        </div>
      </div>
    `;
  }

  function selectInput(id, options){
    return `
      <select id="${id}" class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100">
        ${options.map(o => `<option value="${o.value}">${o.label}</option>`).join("")}
      </select>
    `;
  }

  function toggleButton(id, label){
    return `
      <button id="${id}" type="button" class="flex items-center justify-between gap-3 rounded-2xl border px-3 py-2 text-sm">
        <span class="font-semibold">${label}</span>
        <span class="track relative inline-flex h-6 w-11 items-center rounded-full transition">
          <span class="knob inline-block h-5 w-5 transform rounded-full bg-white shadow transition"></span>
        </span>
      </button>
    `;
  }

  function paintToggle(btn, checked){
    btn.classList.toggle("border-fuchsia-200", checked);
    btn.classList.toggle("bg-fuchsia-50", checked);
    btn.classList.toggle("text-fuchsia-900", checked);

    btn.classList.toggle("border-slate-200", !checked);
    btn.classList.toggle("bg-white", !checked);
    btn.classList.toggle("text-slate-700", !checked);

    const track = btn.querySelector(".track");
    const knob = btn.querySelector(".knob");
    track.className = "track relative inline-flex h-6 w-11 items-center rounded-full transition " + (checked ? "bg-fuchsia-600" : "bg-slate-200");
    knob.className  = "knob inline-block h-5 w-5 transform rounded-full bg-white shadow transition " + (checked ? "translate-x-5" : "translate-x-1");
  }

  function autoYearlyBands(which){
    const months = getTermPeriods(state.inputs);
    const blocks = [];
    let start = 1;
    while(start <= months){
      const end = Math.min(months, start + 11);
      blocks.push({ startMonth: start, endMonth: end, annualRate: 0.105 });
      start = end + 1;
    }
    if(which === "A") state.scheduleA = blocks;
    else state.scheduleB = blocks;
  }

  function renderSchedulesTable(which){
    const sched = normalizeSchedule(which === "A" ? state.scheduleA : state.scheduleB);
    const tableId = `sched${which}`;

    return `
      <div>
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-bold text-slate-900">Schedule ${which} bands</div>
          <div class="flex items-center gap-2">
            <button data-add-band="${which}" class="rounded-2xl bg-gradient-to-r from-fuchsia-600 to-indigo-600 px-3 py-2 text-xs font-extrabold text-white shadow hover:opacity-95">Add band</button>
            <button data-auto-bands="${which}" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50">Auto yearly bands</button>
          </div>
        </div>
        <div class="mt-3 overflow-auto rounded-2xl border border-slate-200">
          <table class="min-w-full text-sm" id="${tableId}">
            <thead class="sticky top-0 bg-slate-50">
              <tr class="text-left text-xs font-extrabold uppercase tracking-widest text-slate-500">
                <th class="px-3 py-2">Start</th>
                <th class="px-3 py-2">End</th>
                <th class="px-3 py-2">Annual rate</th>
                <th class="px-3 py-2"></th>
              </tr>
            </thead>
            <tbody>
              ${sched.map((b, idx) => `
                <tr class="${idx%2 ? "bg-white" : "bg-slate-50/30"}">
                  <td class="px-3 py-2">
                    <input data-sched="${which}" data-idx="${idx}" data-key="startMonth" type="number" min="1" value="${b.startMonth}"
                      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />
                  </td>
                  <td class="px-3 py-2">
                    <input data-sched="${which}" data-idx="${idx}" data-key="endMonth" type="number" min="${b.startMonth}" value="${b.endMonth}"
                      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />
                  </td>
                  <td class="px-3 py-2">
                    <input data-sched="${which}" data-idx="${idx}" data-key="annualRate" type="number" step="0.001" value="${b.annualRate}"
                      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />
                    <div class="mt-1 text-[11px] text-slate-400">(decimal, e.g. 0.105)</div>
                  </td>
                  <td class="px-3 py-2">
                    <button data-remove-band="${which}" data-idx="${idx}" class="rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-extrabold text-rose-700 hover:bg-rose-100">Remove</button>
                  </td>
                </tr>
              `).join("")}
              ${sched.length === 0 ? `
                <tr><td colspan="4" class="px-3 py-6 text-center text-sm text-slate-500">No bands yet. Add one.</td></tr>
              ` : ""}
            </tbody>
          </table>
        </div>
        <div class="mt-3 text-xs text-slate-500">Tip: yearly resets = 12-month bands (1‚Äì12, 13‚Äì24, ...)</div>
      </div>
    `;
  }

  function render(){
    // compute selected rows
    const scheduleSel = state.inputs.scenario === "A" ? state.scheduleA : state.scheduleB;
    const money = makeMoneyFormatter(state.inputs.currency, state.inputs.customCurrencyCode);

    const { rows: rowsSel, nTotal, missingCoverageFromMonth } = buildAmortization(state.inputs, scheduleSel);
    const rowsA = buildAmortization({ ...state.inputs, scenario:"A" }, state.scheduleA).rows;
    const rowsB = buildAmortization({ ...state.inputs, scenario:"B" }, state.scheduleB).rows;

    const sumSel = summarize(rowsSel);
    const sumA = summarize(rowsA);
    const sumB = summarize(rowsB);

    const balanceData = balanceSeries(rowsSel);
    const yearlyInterestData = yearlyInterest(rowsSel);

    const jumpFlag = (r) => state.inputs.showPaymentJumps && r.rateChanged && Math.abs(r.paymentJump) >= Math.max(0, state.inputs.jumpThreshold);
    const jumpCount = rowsSel.filter(jumpFlag).length;

    // header pills + warning
    document.getElementById("pillRows").textContent = `Rows: ${rowsSel.length}`;
    document.getElementById("pillCovered").textContent = `Covered: ${rowsSel.length}/${nTotal}`;
    document.getElementById("pillJumps").textContent = `Jumps: ${jumpCount}`;
    pill(document.getElementById("pillJumps"), jumpCount > 0 ? "amber" : "green");

    const warn = document.getElementById("coverageWarning");
    if (missingCoverageFromMonth){
      warn.classList.remove("hidden");
      document.getElementById("warnScenario").textContent = state.inputs.scenario;
      document.getElementById("warnMonth").textContent = missingCoverageFromMonth;
    } else {
      warn.classList.add("hidden");
    }

    ALWAYS_VISIBLE.forEach(id => visibility[id] = true);
    renderSectionMenu();

    // build sections
    board.innerHTML = "";

    // Inputs section
    const inputsHTML = `
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
        ${inputField("Principal","loan amount", moneyInput("principal","currency_p","customCurrencyCode_p"))}
        ${inputField("Start date","YYYY-MM-DD", textInput("startDateISO","date"))}
        ${inputField("Term","years or months", termInput("termValue","termUnit"))}

        ${inputField("Payments / year","12 for monthly", textInput("paymentsPerYear","number","1","1"))}
        ${inputField("Extra payment / month","after grace", moneyInput("extraPaymentMonthly","currency_e","customCurrencyCode_e"))}
        ${inputField("Scenario","", selectInput("scenario", [
          {value:"A", label:"A"},
          {value:"B", label:"B"},
        ]))}

        <div class="md:col-span-3">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs text-slate-600">
            Money fields format with <b>comma</b> thousands and <b>dot</b> decimals after you leave the field.
          </div>
        </div>
      </div>
    `;

    // Grace section
    const graceHTML = `
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div class="flex flex-col gap-3">
          ${toggleButton("graceEnabled","Enable grace period")}
          ${inputField("Grace type","", selectInput("graceType", [
            {value:"interest_only", label:"interest_only"},
            {value:"full", label:"full"},
          ]))}
          ${inputField("Grace months","", textInput("graceMonths","number","1","0"))}
          ${toggleButton("capitalizeFullGraceInterest","Capitalize interest (full grace)")}
        </div>
        <div class="flex flex-col gap-3">
          ${toggleButton("showPaymentJumps","Enable payment jump flagging")}
          ${inputField("Jump threshold","", moneyInput("jumpThreshold","currency_j","customCurrencyCode_j"))}
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
            <div class="font-extrabold">How jump works</div>
            <div class="mt-1 text-xs text-slate-600">A row is tagged <b>jump</b> only when the interest rate changes and |Œîpayment| ‚â• threshold.</div>
            <div class="mt-2 flex flex-wrap gap-2">
              <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${jumpCount>0?"bg-amber-100 text-amber-900 ring-amber-200":"bg-emerald-100 text-emerald-900 ring-emerald-200"}">Flagged: ${jumpCount}</span>
              <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Selected: ${state.inputs.scenario}</span>
            </div>
          </div>
        </div>
      </div>
    `;

    // Metrics section
    const metricsHTML = `
      <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
        ${metricCard("Total interest", money(sumSel.totalInterest), "from-fuchsia-600 to-indigo-600")}
        ${metricCard("Total paid", money(sumSel.totalPaid), "from-cyan-500 to-indigo-600")}
        ${metricCard("Max payment", money(sumSel.maxPayment), "from-amber-500 to-fuchsia-600")}
        ${metricCard("Payoff date", sumSel.payoffDate || "‚Äî", "from-emerald-500 to-cyan-500")}
      </div>
    `;

    // Charts section
    const chartsHTML = `
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
        <div class="rounded-3xl border border-slate-200 bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold">Balance over time</div>
              <div class="text-xs text-slate-500">End balance each month</div>
            </div>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-indigo-100 text-indigo-800 ring-indigo-200">Scenario ${state.inputs.scenario}</span>
          </div>
          <div class="mt-3 h-64"><canvas id="balanceChart"></canvas></div>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold">Interest per year</div>
              <div class="text-xs text-slate-500">Sum of interest by calendar year</div>
            </div>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-cyan-100 text-cyan-900 ring-cyan-200">Trend</span>
          </div>
          <div class="mt-3 h-64"><canvas id="interestChart"></canvas></div>
        </div>
      </div>
    `;

    // Compare section
    const compareHTML = `
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
        <div class="lg:col-span-2 overflow-auto rounded-3xl border border-slate-200">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50">
              <tr class="text-left text-xs font-extrabold uppercase tracking-widest text-slate-500">
                <th class="px-3 py-2">Metric</th>
                <th class="px-3 py-2">A</th>
                <th class="px-3 py-2">B</th>
              </tr>
            </thead>
            <tbody>
              ${[
                ["Total interest", money(sumA.totalInterest), money(sumB.totalInterest)],
                ["Total paid", money(sumA.totalPaid), money(sumB.totalPaid)],
                ["Max payment", money(sumA.maxPayment), money(sumB.maxPayment)],
                ["Payoff date", sumA.payoffDate || "‚Äî", sumB.payoffDate || "‚Äî"],
                ["Rate changes", String(sumA.rateChangeCount), String(sumB.rateChangeCount)],
              ].map((row, idx) => `
                <tr class="${idx%2 ? "bg-white" : "bg-slate-50/30"}">
                  <td class="px-3 py-2 font-bold text-slate-800">${row[0]}</td>
                  <td class="px-3 py-2">${row[1]}</td>
                  <td class="px-3 py-2">${row[2]}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-sm font-extrabold">Quick badges</div>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${state.inputs.scenario==="A"?"bg-indigo-100 text-indigo-800 ring-indigo-200":"bg-slate-100 text-slate-700 ring-slate-200"}">Selected A</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${state.inputs.scenario==="B"?"bg-indigo-100 text-indigo-800 ring-indigo-200":"bg-slate-100 text-slate-700 ring-slate-200"}">Selected B</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${jumpCount>0?"bg-amber-100 text-amber-900 ring-amber-200":"bg-emerald-100 text-emerald-900 ring-emerald-200"}">Flagged jumps: ${jumpCount}</span>
          </div>
          <div class="mt-3 text-xs text-slate-600">Tip: collapse schedules if you only want to focus on results.</div>
        </div>
      </div>
    `;

    // Schedules
    const scheduleAHTML = renderSchedulesTable("A");
    const scheduleBHTML = renderSchedulesTable("B");

    // Repayment table
    const rightTable = `
      <div class="flex flex-wrap items-center gap-2">
        <button id="exportCSV" class="rounded-2xl bg-gradient-to-r from-fuchsia-600 to-indigo-600 px-3 py-2 text-xs font-extrabold text-white shadow hover:opacity-95">
          <span class="inline-flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-white">
              <path d="M12 3v10m0 0 4-4m-4 4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M4 17v3h16v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Export CSV
          </span>
        </button>
      </div>
    `;

    const tableHTML = `
      <div>
        <div class="mb-3 flex flex-wrap items-center gap-2">
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Rates = decimals</span>
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Re-amortize monthly</span>
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${jumpCount>0?"bg-amber-100 text-amber-900 ring-amber-200":"bg-emerald-100 text-emerald-900 ring-emerald-200"}">Flagged: ${jumpCount}</span>
        </div>

        <div class="overflow-auto rounded-3xl border border-slate-200">
          <table class="min-w-full text-sm">
            <thead class="sticky top-0 bg-slate-50">
              <tr class="text-left text-xs font-extrabold uppercase tracking-widest text-slate-500">
                <th class="px-3 py-2">#</th>
                <th class="px-3 py-2">Date</th>
                <th class="px-3 py-2">Rate</th>
                <th class="px-3 py-2 text-right">Begin</th>
                <th class="px-3 py-2 text-right">Payment</th>
                <th class="px-3 py-2 text-right">Interest</th>
                <th class="px-3 py-2 text-right">Principal</th>
                <th class="px-3 py-2 text-right">Extra</th>
                <th class="px-3 py-2 text-right">End</th>
                <th class="px-3 py-2">Flags</th>
              </tr>
            </thead>
            <tbody>
              ${rowsSel.length ? rowsSel.map((r, idx) => {
                const flagged = jumpFlag(r);
                const zebra = idx % 2 === 1;
                const rowBg = flagged ? "bg-amber-50" : (zebra ? "bg-white" : "bg-slate-50/30");
                return `
                  <tr class="border-t border-slate-100 ${rowBg}">
                    <td class="px-3 py-2 font-bold text-slate-800">${r.period}</td>
                    <td class="px-3 py-2 text-slate-700">${r.dateISO}</td>
                    <td class="px-3 py-2">
                      <div class="flex flex-wrap items-center gap-2">
                        <span class="font-bold text-slate-800">${formatPct(r.annualRate)}</span>
                        ${r.rateChanged ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-amber-100 text-amber-900 ring-amber-200">rate</span>` : ""}
                      </div>
                    </td>
                    <td class="px-3 py-2 text-right tabular">${money(r.beginBalance)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.payment)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.interest)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.principal)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.extra)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.endBalance)}</td>
                    <td class="px-3 py-2">
                      <div class="flex flex-wrap gap-2">
                        ${r.note ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">${r.note}</span>` : ""}
                        ${flagged ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-amber-100 text-amber-900 ring-amber-200">jump</span>` : ""}
                        ${state.inputs.showPaymentJumps && r.rateChanged ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Œî ${money(r.paymentJump)}</span>` : ""}
                      </div>
                    </td>
                  </tr>
                `;
              }).join("") : `
                <tr>
                  <td colspan="10" class="px-3 py-10 text-center text-sm text-slate-500">Nothing to show yet. Add rate bands starting from month 1.</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="mt-3 text-xs text-slate-500">Payment jumps are flagged only when the rate changes and |Œîpayment| ‚â• your threshold.</div>
      </div>
    `;

    // Create + append sections in current order
    const sections = {
      inputs: sectionShell("inputs", inputsHTML),
      grace: sectionShell("grace", graceHTML),
      metrics: sectionShell("metrics", metricsHTML),
      charts: sectionShell("charts", chartsHTML),
      compare: sectionShell("compare", compareHTML),
      scheduleA: sectionShell("scheduleA", scheduleAHTML),
      scheduleB: sectionShell("scheduleB", scheduleBHTML),
      table: sectionShell("table", tableHTML, rightTable),
    };

    // set order
    layout.order.forEach(id => { if (visibility[id]) board.appendChild(sections[id]); });

    // Wire inputs
    // Inputs
    setMoneyValue("principal", state.inputs.principal, state.inputs.currency);
    setCurrencyControls("currency_p","customCurrencyCode_p");
    setValue("startDateISO", state.inputs.startDateISO);
    setValue("termValue", state.inputs.termValue);
    setValue("termUnit", state.inputs.termUnit);
    setValue("paymentsPerYear", state.inputs.paymentsPerYear);
    setMoneyValue("extraPaymentMonthly", state.inputs.extraPaymentMonthly, state.inputs.currency);
    setCurrencyControls("currency_e","customCurrencyCode_e");

    setValue("scenario", state.inputs.scenario);
    

    onCommit("principal", (v)=>{ state.inputs.principal = Math.max(0, parseNumberInput(v)); render(); });
    onInput("startDateISO", (v)=>{ state.inputs.startDateISO = v || state.inputs.startDateISO; render(); });
    onInput("termValue", (v)=>{
      const n = Number(v)||1;
      if (state.inputs.termUnit === "months") state.inputs.termValue = clamp(Math.floor(n), 1, 360);
      else state.inputs.termValue = clamp(n, 1, 30);
      render();
    });

    onInput("termUnit", (u)=>{
      state.inputs.termUnit = (u === "months") ? "months" : "years";
      if (state.inputs.termUnit === "months") state.inputs.termValue = clamp(Math.floor(state.inputs.termValue||1), 1, 360);
      else state.inputs.termValue = clamp(Number(state.inputs.termValue||1), 1, 30);
      render();
    });
    onInput("paymentsPerYear", (v)=>{ state.inputs.paymentsPerYear = clamp(Number(v)||12, 1, 365); render(); });
    onCommit("extraPaymentMonthly", (v)=>{ state.inputs.extraPaymentMonthly = Math.max(0, parseNumberInput(v)); render(); });

    onInput("scenario", (v)=>{ state.inputs.scenario = v === "B" ? "B" : "A"; render(); });
    
    

    // Grace + jumps
    wireToggle("graceEnabled", state.inputs.graceEnabled, (nv)=>{ state.inputs.graceEnabled = nv; render(); });
    setValue("graceType", state.inputs.graceType);
    setValue("graceMonths", state.inputs.graceMonths);
    onInput("graceType", (v)=>{ state.inputs.graceType = v; render(); });
    onInput("graceMonths", (v)=>{ state.inputs.graceMonths = Math.max(0, Math.floor(Number(v)||0)); render(); });
    wireToggle("capitalizeFullGraceInterest", state.inputs.capitalizeFullGraceInterest, (nv)=>{ state.inputs.capitalizeFullGraceInterest = nv; render(); });

    wireToggle("showPaymentJumps", state.inputs.showPaymentJumps, (nv)=>{ state.inputs.showPaymentJumps = nv; render(); });
    setMoneyValue("jumpThreshold", state.inputs.jumpThreshold, state.inputs.currency);
    setCurrencyControls("currency_j","customCurrencyCode_j");
    onCommit("jumpThreshold", (v)=>{ state.inputs.jumpThreshold = Math.max(0, parseNumberInput(v)); render(); });

    // Schedules events
    document.querySelectorAll("[data-add-band]").forEach(btn => {
      btn.addEventListener("click", () => {
        const which = btn.getAttribute("data-add-band");
        const target = which === "A" ? normalizeSchedule(state.scheduleA) : normalizeSchedule(state.scheduleB);
        const last = target[target.length-1];
        const start = last ? last.endMonth + 1 : 1;
        target.push({ startMonth: start, endMonth: start + 11, annualRate: last ? last.annualRate : 0.085 });
        if (which === "A") state.scheduleA = target; else state.scheduleB = target;
        render();
      });
    });

    document.querySelectorAll("[data-auto-bands]").forEach(btn => {
      btn.addEventListener("click", () => {
        const which = btn.getAttribute("data-auto-bands");
        autoYearlyBands(which);
        render();
      });
    });

    document.querySelectorAll("[data-remove-band]").forEach(btn => {
      btn.addEventListener("click", () => {
        const which = btn.getAttribute("data-remove-band");
        const idx = Number(btn.getAttribute("data-idx"));
        const target = normalizeSchedule(which === "A" ? state.scheduleA : state.scheduleB);
        target.splice(idx, 1);
        if (which === "A") state.scheduleA = target; else state.scheduleB = target;
        render();
      });
    });

    document.querySelectorAll("input[data-sched]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const which = inp.getAttribute("data-sched");
        const idx = Number(inp.getAttribute("data-idx"));
        const key = inp.getAttribute("data-key");
        const target = normalizeSchedule(which === "A" ? state.scheduleA : state.scheduleB);
        const val = (e.target.value === "") ? "" : Number(e.target.value);
        if (key === "startMonth") target[idx].startMonth = Math.max(1, Math.floor(val||1));
        if (key === "endMonth") target[idx].endMonth = Math.max(1, Math.floor(val||1));
        if (key === "annualRate") target[idx].annualRate = Number.isFinite(val) ? val : 0;
        if (which === "A") state.scheduleA = target; else state.scheduleB = target;
        render();
      });
    });

    // Export
    const exp = document.getElementById("exportCSV");
    if (exp) exp.addEventListener("click", () => downloadCSV(`amort_${state.inputs.scenario}.csv`, rowsSel));

    // Native Drag & Drop (handle drags the whole section)
    wireDnD();

    // Charts (Chart.js)
    if (visibility.charts) renderCharts(balanceData, yearlyInterestData, money);
    else {
      if (charts.balance) { charts.balance.destroy(); charts.balance = null; }
      if (charts.interest) { charts.interest.destroy(); charts.interest = null; }
    }
  }

  function metricCard(label, value, gradient){
    return `
      <div class="rounded-3xl bg-gradient-to-br ${gradient} p-[1px]">
        <div class="rounded-3xl bg-white p-4">
          <div class="text-xs font-extrabold text-slate-600">${label}</div>
          <div class="mt-2 text-2xl font-black tracking-tight">${value}</div>
        </div>
      </div>
    `;
  }

  function setValue(id, value){
    const el = document.getElementById(id);
    if (el) el.value = value;
  }

  function setMoneyValue(id, value, currency){
    const el = document.getElementById(id);
    if (!el) return;
    const maxDec = (currency === "VND") ? 0 : 2;
    el.value = formatNumberInput(Number(value) || 0, maxDec);
  }

  // For formatted money fields: only commit on blur/change (avoid fighting cursor)
  function onCommit(id, fn){
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", (e) => fn(e.target.value));
    el.addEventListener("blur", (e) => fn(e.target.value));
  }

  // Wire currency controls (used in multiple money inputs)
  function setCurrencyControls(selectId, customId){
    const sel = document.getElementById(selectId);
    const custom = document.getElementById(customId);
    if (!sel || !custom) return;

    sel.value = state.inputs.currency;
    custom.value = state.inputs.customCurrencyCode || "";
    custom.classList.toggle("hidden", state.inputs.currency !== "CUSTOM");

    sel.addEventListener("change", () => {
      state.inputs.currency = sel.value;
      render();
    });

    custom.addEventListener("input", () => {
      state.inputs.customCurrencyCode = (custom.value || "").toUpperCase();
      // no full rerender needed on each key, but keep it simple
      render();
    });
  }

  function onInput(id, fn){
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", (e) => fn(e.target.value));
    el.addEventListener("change", (e) => fn(e.target.value));
  }

  function wireToggle(id, checked, onChange){
    const btn = document.getElementById(id);
    if (!btn) return;
    paintToggle(btn, checked);
    btn.addEventListener("click", () => {
      const next = !checked;
      onChange(next);
    });
  }

  function renderCharts(balanceData, yearlyInterestData, money){
    const balanceCanvas = document.getElementById("balanceChart");
    const interestCanvas = document.getElementById("interestChart");
    if (!balanceCanvas || !interestCanvas) return;

    // destroy old
    if (charts.balance) charts.balance.destroy();
    if (charts.interest) charts.interest.destroy();

    const balLabels = balanceData.map(d => d.date);
    const balVals = balanceData.map(d => d.balance);

    charts.balance = new Chart(balanceCanvas, {
      type: "line",
      data: {
        labels: balLabels,
        datasets: [{
          label: "Balance",
          data: balVals,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${money(Number(ctx.parsed.y))}`
            }
          },
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: {
            ticks: { callback: (v) => money(Number(v)) },
            grid: { drawBorder: false }
          }
        }
      }
    });

    const yiLabels = yearlyInterestData.map(d => String(d.year));
    const yiVals = yearlyInterestData.map(d => d.interest);

    charts.interest = new Chart(interestCanvas, {
      type: "bar",
      data: {
        labels: yiLabels,
        datasets: [{
          label: "Interest",
          data: yiVals,
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${money(Number(ctx.parsed.y))}`
            }
          },
          legend: { display: false }
        },
        scales: {
          y: {
            ticks: { callback: (v) => money(Number(v)) },
            grid: { drawBorder: false }
          }
        }
      }
    });
  }

  // -----------------------
  // Drag & Drop
  // -----------------------
  let dragEl = null;

  function wireDnD(){
    // remove any old listeners by cloning handles (simple + effective)
    document.querySelectorAll(".handle").forEach(h => {
      const clone = h.cloneNode(true);
      h.parentNode.replaceChild(clone, h);
    });

    document.querySelectorAll(".handle").forEach(handle => {
      handle.addEventListener("dragstart", (e) => {
        dragEl = handle.closest("[data-id]");
        if (!dragEl) return;
        dragEl.classList.add("dragging");
        e.dataTransfer.setData("text/plain", dragEl.dataset.id);
        e.dataTransfer.effectAllowed = "move";
      });

      handle.addEventListener("dragend", () => {
        if (dragEl) dragEl.classList.remove("dragging");
        document.querySelectorAll("[data-id]").forEach(c => c.classList.remove("drop-hint"));
        dragEl = null;
        // save order
        const visibleOrder = Array.from(board.querySelectorAll("[data-id]")).map(x => x.dataset.id);
        const hiddenOrder = layout.order.filter(id => !visibleOrder.includes(id));
        layout.order = [...visibleOrder, ...hiddenOrder];
        saveLayout(layout.order, layout.collapsed);
      });
    });

    // dragover on board
    board.addEventListener("dragover", (e) => {
      if (!dragEl) return;
      e.preventDefault();
      const over = e.target.closest("[data-id]");
      if (!over || over === dragEl) return;

      document.querySelectorAll("[data-id]").forEach(c => c.classList.remove("drop-hint"));
      over.classList.add("drop-hint");

      const rect = over.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      if (before) board.insertBefore(dragEl, over);
      else board.insertBefore(dragEl, over.nextSibling);
    }, { passive:false });

    board.addEventListener("drop", (e) => {
      e.preventDefault();
    });
  }

  // -----------------------
  // Header buttons
  // -----------------------
  document.getElementById("resetLayoutBtn").addEventListener("click", () => {
    try {
      localStorage.removeItem(LS_ORDER);
      localStorage.removeItem(LS_COLLAPSED);
      localStorage.removeItem(LS_VISIBLE);
    } catch {}
    layout = loadLayout();
    visibility = loadVisibility();
    render();
  });

  // initial render
  render();
</script>
</body>
</html>
