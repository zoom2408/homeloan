<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Loan Lab (Previewable)</title>
  <!--
    Single-file, previewable (open index.html in browser)

    Features implemented from this chat:
    - Amortized loan with monthly payments
    - Fixed period then floating rate (manual rate schedule bands)
    - Grace period: interest-only or full; optional capitalization for full-grace
    - Floating rate editable: just type your own rate in bands
    - Toggle to flag ‚Äúpayment jumps‚Äù when rate changes (+ threshold)
    - Charts: Balance over time, Interest paid per year
    - Scenario A/B comparison: two independent Rate Schedule tables; select A/B via dropdown
    - Draggable dashboard sections + collapsible sections; layout persisted in localStorage
    - Export repayment table to CSV

    Notes:
    - Rates are decimals (0.105 = 10.5% annually)
    - Re-amortizes each month based on current rate and remaining term

    DnD note:
    - Uses pointer-based dragging (not HTML5 dragstart/dragend) to avoid browser quirks.
  -->

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Hide scrollbars but keep scrolling */
    .no-scrollbar::-webkit-scrollbar{display:none;}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none;}
    :root{ color-scheme: light; }
    /* fintech sparkle */
    .bg-fintech{
      background:
        radial-gradient(900px 500px at 20% 0, rgba(217,70,239,.18), transparent 55%),
        radial-gradient(900px 500px at 80% 0, rgba(99,102,241,.20), transparent 55%),
        linear-gradient(to bottom, #f8fafc, white);
    }
    .card-glass{ background: rgba(255,255,255,.80); backdrop-filter: blur(10px); }

    .handle{ touch-action:none; user-select:none; }
    .dragging{ opacity:.65; }
    .drop-hint{ outline: 2px solid rgba(217,70,239,.35); outline-offset: 2px; }
    .ghost{
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      transform: translate3d(0,0,0);
    }
    .placeholder{
      border-radius: 24px;
      border: 2px dashed rgba(217,70,239,.35);
      background: rgba(217,70,239,.06);
    }

    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display:none; }
    .tabular{ font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-fintech text-slate-900 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="mb-6 rounded-[28px] border border-slate-200 card-glass shadow-sm">
      <div class="p-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <div class="inline-flex items-center gap-2">
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-gradient-to-tr from-fuchsia-600 to-indigo-600 text-white shadow">üè†</span>
            <h1 class="text-2xl font-extrabold tracking-tight">Home Loan Simulator</h1>
          </div>
          <p class="mt-2 max-w-2xl text-sm text-slate-600">
            Drag sections to rearrange your dashboard. Collapse what you don‚Äôt need. Rates are manual bands (Scenario A/B).
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
        
          
          <span id="pillRows" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Rows: ‚Äî</span>
          <span id="pillCovered" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Covered: ‚Äî</span>
          <span id="pillJumps" class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-emerald-100 text-emerald-900 ring-emerald-200">Jumps: ‚Äî</span>
          <button id="resetLayoutBtn" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50">
            Reset layout
          </button>
           <button id="menuBtn" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50" title="Sections" type="button">
            <span class="inline-flex items-center gap-2">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-slate-700">
                <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
              Setup
            </span>
          </button>
        </div>
      </div>
      <div id="coverageWarning" class="hidden px-6 pb-6">
        <div class="rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-800">
          Selected schedule (<b id="warnScenario">A</b>) doesn‚Äôt cover month <b id="warnMonth">‚Äî</b> onward. Add a band.
        </div>
      </div>
    </div>

    <!-- Board (draggable sections) -->
    <div id="board" class="grid grid-cols-1 gap-4"></div>

    <!-- Slideout menu -->
    <div id="menuOverlay" class="fixed inset-0 z-[10000] hidden">
      <div id="menuBackdrop" class="absolute inset-0 bg-slate-900/30 backdrop-blur-[1px]"></div>
      <aside id="menuPanel" class="absolute right-0 top-0 flex h-full w-[320px] max-w-[88vw] translate-x-full flex-col bg-white shadow-2xl transition-transform duration-200">
        <div class="flex items-center justify-between border-b border-slate-100 p-4">
          <div>
            <div class="text-sm font-extrabold text-slate-900">Sections</div>
            <div class="text-xs text-slate-500">Choose what appears on your dashboard</div>
          </div>
          <button id="menuClose" class="grid h-9 w-9 place-items-center rounded-2xl border border-slate-200 bg-white hover:bg-slate-50" type="button" aria-label="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-slate-700">
              <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600">
            Default sections are always on: <b>Inputs</b>, <b>Grace & Jump rules</b>, <b>Key metrics</b>, <b>Repayment table</b>.
            Toggle the optional sections below.
          </div>

          <div class="mt-4 space-y-2" id="menuList"></div>
          <div class="mt-3 text-[11px] text-slate-500">Drag the handle to reorder sections. Order is shared with the main dashboard.</div>

          <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-3 text-xs text-slate-600">
            Tip: your choices are saved in this browser.
          </div>
        </div>
      </aside>
    </div>

    <div class="mt-8 text-center text-xs text-slate-500">This calculator is for estimation only.</div>
  </div>

<script>
  // -----------------------
  // Utilities
  // -----------------------
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  const toISODate = (d) => {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const addMonthsISO = (startISO, monthsToAdd) => {
    const [y, m, d] = startISO.split("-").map(x => parseInt(x, 10));
    const dt = new Date(y, m - 1, d);
    dt.setMonth(dt.getMonth() + monthsToAdd);
    return toISODate(dt);
  };

  const pmt = (ratePerPeriod, nPeriods, presentValue) => {
    if (nPeriods <= 0) return 0;
    if (Math.abs(ratePerPeriod) < 1e-12) return presentValue / nPeriods;
    const r = ratePerPeriod;
    const pow = Math.pow(1 + r, nPeriods);
    return (presentValue * r * pow) / (pow - 1);
  };

  const normalizeSchedule = (schedule) => {
    return [...schedule]
      .map(b => ({
        startMonth: Math.max(1, Math.floor(b.startMonth || 1)),
        endMonth: Math.max(1, Math.floor(b.endMonth || 1)),
        annualRate: Number.isFinite(b.annualRate) ? b.annualRate : 0,
      }))
      .sort((a,b) => a.startMonth - b.startMonth);
  };

  const getAnnualRateForMonth = (schedule, month) => {
    for (const band of schedule) {
      if (month >= band.startMonth && month <= band.endMonth) return band.annualRate;
    }
    return null;
  };

  const formatPct = (x) => Number.isFinite(x) ? `${(x*100).toFixed(3)}%` : "";

  // Number formatting for inputs: comma thousands + dot decimals (force en-US style)
  const formatNumberInput = (n, maxDecimals = 2) => {
    if (!Number.isFinite(n)) return "";
    const dec = Math.max(0, Math.min(12, maxDecimals));
    return new Intl.NumberFormat("en-US", {
      useGrouping: true,
      maximumFractionDigits: dec,
    }).format(n);
  };

  const parseNumberInput = (s) => {
    if (s == null) return 0;
    const cleaned = String(s)
      .trim()
      .replace(/,/g, "")
      .replace(/[^0-9.\-]/g, "");
    if (cleaned === "" || cleaned === "-" || cleaned === ".") return 0;
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  };

  const makeMoneyFormatter = (currency, customCode) => {
    const code = currency === "CUSTOM" ? (customCode || "USD") : currency;
    return (n) => {
      if (!Number.isFinite(n)) return "";
      try {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: code,
          maximumFractionDigits: code === "VND" ? 0 : 2,
        }).format(n);
      } catch {
        return new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 }).format(n);
      }
    };
  };

  const summarize = (rows) => {
    const totalInterest = rows.reduce((s,r) => s + r.interest, 0);
    const totalPaid = rows.reduce((s,r) => s + r.payment + r.extra, 0);
    const maxPayment = rows.reduce((m,r) => Math.max(m, r.payment), 0);
    const payoffDate = rows.length ? rows[rows.length-1].dateISO : "";
    const rateChangeCount = rows.filter(r => r.rateChanged).length;
    return { totalInterest, totalPaid, maxPayment, payoffDate, rateChangeCount };
  };

  const yearlyInterest = (rows) => {
    const map = new Map();
    for (const r of rows) {
      const y = parseInt(r.dateISO.slice(0,4), 10);
      map.set(y, (map.get(y) || 0) + r.interest);
    }
    return Array.from(map.entries())
      .sort((a,b)=>a[0]-b[0])
      .map(([year, interest]) => ({ year, interest }));
  };

  const balanceSeries = (rows) => rows.map(r => ({ date: r.dateISO, balance: r.endBalance }));

  // Term helper
  const getTermPeriods = (inputs) => {
    const ppY = inputs.paymentsPerYear;
    if (inputs.termUnit === "months") return clamp(Math.floor(inputs.termValue || 1), 1, 360);
    const years = clamp(Number(inputs.termValue || 1), 1, 30);
    return Math.min(Math.floor(years * ppY), 360);
  };

  const buildAmortization = (inputs, schedule) => {
    const sched = normalizeSchedule(schedule);
    const nTotal = getTermPeriods(inputs);
    const ppY = inputs.paymentsPerYear;
    const graceMonths = inputs.graceEnabled ? Math.max(0, Math.floor(inputs.graceMonths)) : 0;

    const rows = [];
    let bal = inputs.principal;
    let missingCoverageFromMonth = null;

    for (let period = 1; period <= nTotal; period++) {
      const annualRate = getAnnualRateForMonth(sched, period);
      if (annualRate == null) { missingCoverageFromMonth = period; break; }

      const monthlyRate = annualRate / ppY;
      const begin = bal;
      const dateISO = addMonthsISO(inputs.startDateISO, period - 1);

      const inGrace = inputs.graceEnabled && period <= graceMonths;
      const note = inGrace ? `Grace: ${inputs.graceType}` : "";

      const interest = begin * monthlyRate;

      let payment = 0;
      if (begin <= 0) {
        payment = 0;
      } else if (inGrace) {
        payment = inputs.graceType === "full" ? 0 : interest;
      } else {
        const remaining = nTotal - period + 1;
        payment = pmt(monthlyRate, remaining, begin);
        payment = Math.min(payment, begin + interest);
      }

      const principalPaid = Math.max(0, payment - interest);

      const extra =
        begin <= 0 ? 0 : (inGrace ? 0 : Math.min(Math.max(0, inputs.extraPaymentMonthly), Math.max(0, begin - principalPaid)));

      let end = begin - principalPaid - extra;

      if (inGrace && inputs.graceType === "full" && inputs.capitalizeFullGraceInterest) {
        end = begin + interest;
      }

      end = Math.max(0, end);

      const prev = rows[rows.length - 1];
      const rateChanged = prev ? Math.abs(prev.annualRate - annualRate) > 1e-12 : false;
      const paymentJump = prev ? (payment - prev.payment) : 0;

      rows.push({
        period,
        dateISO,
        annualRate,
        monthlyRate,
        beginBalance: begin,
        payment,
        interest,
        principal: principalPaid,
        extra,
        endBalance: end,
        rateChanged,
        paymentJump,
        note,
      });

      bal = end;
      if (bal <= 0) break;
    }

    return { rows, nTotal, missingCoverageFromMonth };
  };

  const downloadCSV = (filename, rows) => {
    const headers = [
      "Period","Date","AnnualRate","BeginBalance","Payment","Interest","Principal","Extra","EndBalance","RateChanged","PaymentJump","Note"
    ];
    const lines = [headers.join(",")];
    for (const r of rows) {
      lines.push([
        r.period,
        r.dateISO,
        r.annualRate,
        r.beginBalance,
        r.payment,
        r.interest,
        r.principal,
        r.extra,
        r.endBalance,
        r.rateChanged,
        r.paymentJump,
        JSON.stringify(r.note || ""),
      ].join(","));
    }
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // -----------------------
  // State
  // -----------------------
  const state = {
    inputs: {
      principal: 2_000_000_000,
      startDateISO: "2026-01-01",
      termUnit: "years", // years | months
      termValue: 20,
      paymentsPerYear: 12,
      extraPaymentMonthly: 0,

      graceEnabled: false,
      graceType: "interest_only", // interest_only | full
      graceMonths: 0,
      capitalizeFullGraceInterest: false,

      scenario: "A", // A | B

      showPaymentJumps: true,
      jumpThreshold: 500_000,

      currency: "VND", // VND | USD | EUR | CUSTOM
      customCurrencyCode: "USD",
    },
    scheduleA: [
      { startMonth: 1, endMonth: 24, annualRate: 0.085 },
      { startMonth: 25, endMonth: 240, annualRate: 0.105 },
    ],
    scheduleB: [
      { startMonth: 1, endMonth: 24, annualRate: 0.085 },
      { startMonth: 25, endMonth: 60, annualRate: 0.11 },
      { startMonth: 61, endMonth: 240, annualRate: 0.102 },
    ],
  };

  // -----------------------
  // Layout persistence
  // -----------------------
  const LS_ORDER = "hl_html_order_v3";
  const LS_COLLAPSED = "hl_html_collapsed_v3";
  const LS_VISIBLE = "hl_html_visible_v1";

  const DEFAULT_ORDER = ["inputs","grace","metrics","charts","compare","scheduleA","scheduleB","table"];

  const DEFAULT_VISIBLE = {
    inputs: true,
    grace: true,
    metrics: true,
    table: true,
    // Optional sections default ON
    charts: true,
    compare: true,
    scheduleA: true,
    scheduleB: true,
  };

  const sectionMeta = {
    inputs:   { title: "Inputs",           subtitle: "Loan basics + scenario + currency" },
    grace:    { title: "Grace & Jump rules", subtitle: "Grace period + jump threshold" },
    metrics:  { title: "Key metrics",      subtitle: "Selected scenario summary" },
    charts:   { title: "Charts",           subtitle: "Balance + interest per year" },
    compare:  { title: "Scenario A/B",     subtitle: "Same inputs, different schedules" },
    scheduleA:{ title: "Rate Schedule A",  subtitle: "Manual bands" },
    scheduleB:{ title: "Rate Schedule B",  subtitle: "Manual bands" },
    table:    { title: "Repayment table",  subtitle: "Full amortization list" },
  };

  function loadLayout(){
    let order = DEFAULT_ORDER;
    let collapsed = {
      inputs:false, grace:false, metrics:false, charts:false, compare:false, scheduleA:true, scheduleB:true, table:false
    };
    let visible = { ...DEFAULT_VISIBLE };

    try {
      const rawOrder = JSON.parse(localStorage.getItem(LS_ORDER) || "null");
      if (Array.isArray(rawOrder)) {
        const known = new Set(DEFAULT_ORDER);
        const cleaned = rawOrder.filter(id => known.has(id));
        DEFAULT_ORDER.forEach(id => { if(!cleaned.includes(id)) cleaned.push(id); });
        order = cleaned;
      }
      const rawCol = JSON.parse(localStorage.getItem(LS_COLLAPSED) || "null");
      if (rawCol && typeof rawCol === "object") {
        collapsed = { ...collapsed, ...rawCol };
      }
      const rawVis = JSON.parse(localStorage.getItem(LS_VISIBLE) || "null");
      if (rawVis && typeof rawVis === "object") {
        visible = { ...visible, ...rawVis };
      }
    } catch {}

    // Required sections always visible
    visible.inputs = true;
    visible.grace = true;
    visible.metrics = true;
    visible.table = true;

    return { order, collapsed, visible };
  }

  function saveLayout(order, collapsed, visible){
    try {
      localStorage.setItem(LS_ORDER, JSON.stringify(order));
      localStorage.setItem(LS_COLLAPSED, JSON.stringify(collapsed));
      if (visible) localStorage.setItem(LS_VISIBLE, JSON.stringify(visible));
    } catch {}
  }

  let layout = loadLayout();

  // -----------------------
  // Slideout menu helpers
  // -----------------------
  const REQUIRED_SECTIONS = ["inputs","grace","metrics","table"];

  const menuOverlay = document.getElementById("menuOverlay");
  const menuPanel = document.getElementById("menuPanel");
  const menuBackdrop = document.getElementById("menuBackdrop");
  const menuList = document.getElementById("menuList");
  const menuBtn = document.getElementById("menuBtn");
  const menuClose = document.getElementById("menuClose");

  function openMenu(){
    if (!menuOverlay || !menuPanel) return;
    menuOverlay.classList.remove("hidden");
    // allow layout to paint before slide-in
    requestAnimationFrame(() => menuPanel.classList.remove("translate-x-full"));
  }

  function closeMenu(){
    if (!menuOverlay || !menuPanel) return;
    menuPanel.classList.add("translate-x-full");
    setTimeout(() => menuOverlay.classList.add("hidden"), 180);
  }

  function renderMenu(){
    if (!menuList) return;

    // enforce required sections
    for (const id of REQUIRED_SECTIONS) layout.visible[id] = true;

    const ids = Array.isArray(layout.order) && layout.order.length ? [...layout.order] : [...DEFAULT_ORDER];
    menuList.innerHTML = ids.map(id => {
      const required = REQUIRED_SECTIONS.includes(id);
      const checked = !!layout.visible?.[id];
      const meta = sectionMeta[id];
      return `
        <div data-menu-id="${id}" class="menu-item flex items-start justify-between gap-3 rounded-2xl border border-slate-200 bg-white p-3 hover:bg-slate-50">
          <div class="flex items-start gap-2 min-w-0">
            <button type="button" class="menu-handle mt-1 grid h-7 w-7 place-items-center rounded-xl border border-slate-200 bg-white text-slate-500 cursor-grab active:cursor-grabbing" title="Reorder">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <path d="M10 4H4v6h6V4Zm10 0h-6v6h6V4ZM10 14H4v6h6v-6Zm10 0h-6v6h6v-6Z" fill="currentColor" opacity=".7" />
              </svg>
            </button>
            <div class="min-w-0">
              <div class="text-sm font-extrabold text-slate-900">${meta.title}${required ? " <span class='text-[11px] font-black text-slate-400'>(required)</span>" : ""}</div>
              <div class="text-xs text-slate-500">${meta.subtitle}</div>
            </div>
          </div>

          <button
            type="button"
            data-vis="${id}"
            ${required ? "disabled" : ""}
            aria-checked="${checked ? "true" : "false"}"
            role="switch"
            class="menuToggle relative mt-1 inline-flex h-7 w-12 items-center rounded-full transition ${checked ? "bg-fuchsia-600" : "bg-slate-200"} ${required ? "opacity-60 cursor-not-allowed" : "cursor-pointer"}">
            <span class="inline-block h-6 w-6 transform rounded-full bg-white shadow transition ${checked ? "translate-x-5" : "translate-x-1"}"></span>
          </button>
        </div>
      `;
    }).join("");

    menuList.querySelectorAll("button[data-vis]").forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute("data-vis");
        const required = REQUIRED_SECTIONS.includes(id);
        if (required) return;

        const current = !!layout.visible?.[id];
        const next = !current;
        layout.visible[id] = next;
        for (const rid of REQUIRED_SECTIONS) layout.visible[rid] = true;

        saveLayout(layout.order, layout.collapsed, layout.visible);
        render();
        renderMenu();
      };
    });
  }

  // Menu events
  if (menuBtn) menuBtn.addEventListener("click", () => { renderMenu(); openMenu(); });
  if (menuClose) menuClose.addEventListener("click", closeMenu);
  if (menuBackdrop) menuBackdrop.addEventListener("click", closeMenu);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape" && menuOverlay && !menuOverlay.classList.contains("hidden")) closeMenu(); });

  // -----------------------
  // Menu drag & drop (reorder sections)
  // - Pointer-based like the dashboard (robust)
  // - Drag handle only
  // - Live updates: updates layout.order immediately, re-renders dashboard + menu
  // -----------------------
  const menuDnd = {
    draggingEl: null,
    placeholder: null,
    ghost: null,
    offsetX: 0,
    offsetY: 0,
    activePointerId: null,
  };

  const cleanupMenuDnD = () => {
    if (menuDnd.draggingEl) menuDnd.draggingEl.classList.remove("dragging");
    if (menuDnd.placeholder && menuDnd.placeholder.parentNode) menuDnd.placeholder.parentNode.removeChild(menuDnd.placeholder);
    if (menuDnd.ghost && menuDnd.ghost.parentNode) menuDnd.ghost.parentNode.removeChild(menuDnd.ghost);

    menuDnd.draggingEl = null;
    menuDnd.placeholder = null;
    menuDnd.ghost = null;
    menuDnd.activePointerId = null;

    // Save order from menu DOM
    if (menuList) {
      const newOrder = Array.from(menuList.querySelectorAll("[data-menu-id]")).map(el => el.getAttribute("data-menu-id"));
      // sanitize
      const known = new Set(DEFAULT_ORDER);
      const cleaned = newOrder.filter(id => known.has(id));
      DEFAULT_ORDER.forEach(id => { if (!cleaned.includes(id)) cleaned.push(id); });
      layout.order = cleaned;
      saveLayout(layout.order, layout.collapsed, layout.visible);
    }
  };

  const makeMenuGhost = (el) => {
    const rect = el.getBoundingClientRect();
    const g = el.cloneNode(true);
    g.classList.add("ghost");
    g.style.width = rect.width + "px";
    g.style.left = rect.left + "px";
    g.style.top = rect.top + "px";
    g.style.opacity = "0.96";
    g.style.borderRadius = "20px";
    g.style.boxShadow = "0 16px 30px rgba(15,23,42,.18)";
    document.body.appendChild(g);
    return g;
  };

  const makeMenuPlaceholder = (el) => {
    const rect = el.getBoundingClientRect();
    const p = document.createElement("div");
    p.className = "placeholder";
    p.style.height = rect.height + "px";
    p.style.borderRadius = "20px";
    return p;
  };

  const updateMenuGhostPos = (clientX, clientY) => {
    if (!menuDnd.ghost) return;
    menuDnd.ghost.style.left = (clientX - menuDnd.offsetX) + "px";
    menuDnd.ghost.style.top  = (clientY - menuDnd.offsetY) + "px";
  };

  const getMenuItemFromPoint = (clientX, clientY) => {
    const el = document.elementFromPoint(clientX, clientY);
    if (!el) return null;
    const item = el.closest("[data-menu-id]");
    if (!item || item === menuDnd.draggingEl) return null;
    return item;
  };

  const placeMenuPlaceholder = (overEl, clientY) => {
    if (!overEl || !menuDnd.placeholder) return;
    const rect = overEl.getBoundingClientRect();
    const before = (clientY - rect.top) < rect.height / 2;
    if (before) overEl.parentNode.insertBefore(menuDnd.placeholder, overEl);
    else overEl.parentNode.insertBefore(menuDnd.placeholder, overEl.nextSibling);
  };

  // Delegate on menuList
  if (menuList) {
    menuList.addEventListener("pointerdown", (e) => {
      const handle = e.target.closest(".menu-handle");
      if (!handle) return;
      const item = handle.closest("[data-menu-id]");
      if (!item) return;

      e.preventDefault();

      menuDnd.draggingEl = item;
      menuDnd.activePointerId = e.pointerId;

      const rect = item.getBoundingClientRect();
      menuDnd.offsetX = e.clientX - rect.left;
      menuDnd.offsetY = e.clientY - rect.top;

      item.classList.add("dragging");
      menuDnd.placeholder = makeMenuPlaceholder(item);
      item.parentNode.insertBefore(menuDnd.placeholder, item.nextSibling);

      menuDnd.ghost = makeMenuGhost(item);
      updateMenuGhostPos(e.clientX, e.clientY);

      handle.setPointerCapture?.(e.pointerId);
    });

    menuList.addEventListener("pointermove", (e) => {
      if (!menuDnd.draggingEl || menuDnd.activePointerId !== e.pointerId) return;
      updateMenuGhostPos(e.clientX, e.clientY);
      const over = getMenuItemFromPoint(e.clientX, e.clientY);
      if (over) placeMenuPlaceholder(over, e.clientY);
    });

    menuList.addEventListener("pointerup", (e) => {
      if (!menuDnd.draggingEl || menuDnd.activePointerId !== e.pointerId) return;

      if (menuDnd.placeholder && menuDnd.placeholder.parentNode) {
        menuDnd.placeholder.parentNode.insertBefore(menuDnd.draggingEl, menuDnd.placeholder);
      }

      cleanupMenuDnD();

      // Live update: reflect new order immediately
      render();
      renderMenu();
    });

    menuList.addEventListener("pointercancel", (e) => {
      if (!menuDnd.draggingEl || menuDnd.activePointerId !== e.pointerId) return;
      cleanupMenuDnD();
      render();
      renderMenu();
    });
  }

  // -----------------------
  // DOM helpers
  // -----------------------
  const board = document.getElementById("board");
  let charts = { balance: null, interest: null };

  function pill(el, tone){
    const map = {
      slate:   "bg-slate-100 text-slate-700 ring-slate-200",
      indigo:  "bg-indigo-100 text-indigo-800 ring-indigo-200",
      amber:   "bg-amber-100 text-amber-900 ring-amber-200",
      green:   "bg-emerald-100 text-emerald-900 ring-emerald-200",
      rose:    "bg-rose-100 text-rose-900 ring-rose-200",
      cyan:    "bg-cyan-100 text-cyan-900 ring-cyan-200",
    };
    el.className = "inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 " + (map[tone] || map.slate);
  }

  function sectionShell(id, innerHTML, rightHTML=""){
    const meta = sectionMeta[id];
    const isCollapsed = !!layout.collapsed[id];

    const wrap = document.createElement("div");
    wrap.dataset.id = id;

    wrap.innerHTML = `
      <div class="rounded-3xl border border-slate-200 card-glass shadow-sm overflow-hidden">
        <div class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-100 px-5 py-4">
          <div class="flex items-center gap-3">
            <button class="handle grid h-9 w-9 place-items-center rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 cursor-grab active:cursor-grabbing select-none" title="Drag to reorder" type="button">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-slate-500">
                <path d="M10 4H4v6h6V4Zm10 0h-6v6h6V4ZM10 14H4v6h6v-6Zm10 0h-6v6h6v-6Z" fill="currentColor" opacity=".75" />
              </svg>
            </button>
            <div>
              <div class="flex items-center gap-2">
                <div class="text-sm font-extrabold tracking-tight text-slate-900">${meta.title}</div>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-fuchsia-700">
                  <path d="M12 2l1.6 5.2L19 9l-5.4 1.8L12 16l-1.6-5.2L5 9l5.4-1.8L12 2Z" fill="currentColor" opacity=".85" />
                </svg>
              </div>
              <div class="text-xs text-slate-500">${meta.subtitle}</div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            ${rightHTML}
            <button class="toggle rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-bold text-slate-700 hover:bg-slate-50" type="button">
              <span class="inline-flex items-center gap-2">
                <span class="label">${isCollapsed ? "Expand" : "Collapse"}</span>
                <span class="chev transition-transform ${isCollapsed ? "rotate-180" : "rotate-0"}">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-slate-600">
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </span>
              </span>
            </button>
          </div>
        </div>

        <div class="body px-5 py-4 ${isCollapsed ? "hidden" : ""}">
          ${innerHTML}
        </div>
      </div>
    `;

    wrap.querySelector(".toggle").addEventListener("click", () => {
      layout.collapsed[id] = !layout.collapsed[id];
      saveLayout(layout.order, layout.collapsed, layout.visible);
      render();
    });

    return wrap;
  }

  function inputField(label, hint, inputHTML){
    return `
      <div class="flex flex-col gap-1">
        <div class="flex items-center justify-between">
          <div class="text-xs font-semibold text-slate-700">${label}</div>
          ${hint ? `<div class="text-[11px] text-slate-400">${hint}</div>` : ""}
        </div>
        ${inputHTML}
      </div>
    `;
  }

  function textInput(id, type="text", step="", min="", placeholder=""){
    const stepAttr = step !== "" ? `step="${step}"` : "";
    const minAttr = min !== "" ? `min="${min}"` : "";
    const phAttr = placeholder ? `placeholder="${placeholder}"` : "";
    return `<input id="${id}" type="${type}" ${stepAttr} ${minAttr} ${phAttr}
      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none placeholder:text-slate-400 focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />`;
  }

  function termInput(valueId, unitId){
    return `
      <div class="flex items-stretch overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm focus-within:ring-2 focus-within:ring-fuchsia-100 focus-within:border-fuchsia-300">
        <input id="${valueId}" type="number" min="1"
          class="h-10 w-full bg-transparent px-3 text-sm text-slate-900 outline-none" />
        <div class="border-l border-slate-200 bg-slate-50 px-2 flex items-center">
          <select id="${unitId}" class="h-8 rounded-xl border border-slate-200 bg-white px-2 text-xs font-extrabold text-slate-700 outline-none focus:ring-2 focus:ring-fuchsia-100">
            <option value="years">Years (max 30)</option>
            <option value="months">Months (max 360)</option>
          </select>
        </div>
      </div>
    `;
  }

  function moneyInput(id, currencySelectId, customCodeId){
    return `
      <div class="flex items-stretch overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm focus-within:ring-2 focus-within:ring-fuchsia-100 focus-within:border-fuchsia-300">
        <input id="${id}" inputmode="decimal" autocomplete="off" spellcheck="false"
          class="h-10 w-full bg-transparent px-3 text-sm text-slate-900 outline-none placeholder:text-slate-400" />
        <div class="flex items-center gap-2 border-l border-slate-200 bg-slate-50 px-2">
          <select id="${currencySelectId}" class="h-8 rounded-xl border border-slate-200 bg-white px-2 text-xs font-extrabold text-slate-700 outline-none focus:ring-2 focus:ring-fuchsia-100">
            <option value="VND">VND</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="CUSTOM">Custom</option>
          </select>
          <input id="${customCodeId}" class="h-8 w-20 rounded-xl border border-slate-200 bg-white px-2 text-xs font-extrabold text-slate-700 outline-none focus:ring-2 focus:ring-fuchsia-100" placeholder="USD" />
        </div>
      </div>
    `;
  }

  function selectInput(id, options){
    return `
      <select id="${id}" class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100">
        ${options.map(o => `<option value="${o.value}">${o.label}</option>`).join("")}
      </select>
    `;
  }

  function toggleButton(id, label){
    return `
      <button id="${id}" type="button" class="flex items-center justify-between gap-3 rounded-2xl border px-3 py-2 text-sm">
        <span class="font-semibold">${label}</span>
        <span class="track relative inline-flex h-6 w-11 items-center rounded-full transition">
          <span class="knob inline-block h-5 w-5 transform rounded-full bg-white shadow transition"></span>
        </span>
      </button>
    `;
  }

  function paintToggle(btn, checked){
    btn.classList.toggle("border-fuchsia-200", checked);
    btn.classList.toggle("bg-fuchsia-50", checked);
    btn.classList.toggle("text-fuchsia-900", checked);

    btn.classList.toggle("border-slate-200", !checked);
    btn.classList.toggle("bg-white", !checked);
    btn.classList.toggle("text-slate-700", !checked);

    const track = btn.querySelector(".track");
    const knob = btn.querySelector(".knob");
    track.className = "track relative inline-flex h-6 w-11 items-center rounded-full transition " + (checked ? "bg-fuchsia-600" : "bg-slate-200");
    knob.className  = "knob inline-block h-5 w-5 transform rounded-full bg-white shadow transition " + (checked ? "translate-x-5" : "translate-x-1");
  }

  function autoYearlyBands(which){
    const months = getTermPeriods(state.inputs);
    const blocks = [];
    let start = 1;
    while(start <= months){
      const end = Math.min(months, start + 11);
      blocks.push({ startMonth: start, endMonth: end, annualRate: 0.105 });
      start = end + 1;
    }
    if(which === "A") state.scheduleA = blocks;
    else state.scheduleB = blocks;
  }

  function renderSchedulesTable(which){
    const sched = normalizeSchedule(which === "A" ? state.scheduleA : state.scheduleB);
    const tableId = `sched${which}`;

    return `
      <div>
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-bold text-slate-900">Schedule ${which} bands</div>
          <div class="flex items-center gap-2">
            <button data-add-band="${which}" class="rounded-2xl bg-gradient-to-r from-fuchsia-600 to-indigo-600 px-3 py-2 text-xs font-extrabold text-white shadow hover:opacity-95" type="button">Add band</button>
            <button data-auto-bands="${which}" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50" type="button">Auto yearly bands</button>
          </div>
        </div>
        <div class="mt-3 overflow-auto rounded-2xl border border-slate-200">
          <table class="min-w-full text-sm" id="${tableId}">
            <thead class="sticky top-0 bg-slate-50">
              <tr class="text-left text-xs font-extrabold uppercase tracking-widest text-slate-500">
                <th class="px-3 py-2">Start</th>
                <th class="px-3 py-2">End</th>
                <th class="px-3 py-2">Annual rate</th>
                <th class="px-3 py-2"></th>
              </tr>
            </thead>
            <tbody>
              ${sched.map((b, idx) => `
                <tr class="${idx%2 ? "bg-white" : "bg-slate-50/30"}">
                  <td class="px-3 py-2">
                    <input data-sched="${which}" data-idx="${idx}" data-key="startMonth" type="number" min="1" value="${b.startMonth}"
                      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />
                  </td>
                  <td class="px-3 py-2">
                    <input data-sched="${which}" data-idx="${idx}" data-key="endMonth" type="number" min="${b.startMonth}" value="${b.endMonth}"
                      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />
                  </td>
                  <td class="px-3 py-2">
                    <input data-sched="${which}" data-idx="${idx}" data-key="annualRate" type="number" step="0.001" value="${b.annualRate}"
                      class="h-10 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900 shadow-sm outline-none focus:border-fuchsia-300 focus:ring-2 focus:ring-fuchsia-100" />
                    <div class="mt-1 text-[11px] text-slate-400">(decimal, e.g. 0.105)</div>
                  </td>
                  <td class="px-3 py-2">
                    <button data-remove-band="${which}" data-idx="${idx}" class="rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-extrabold text-rose-700 hover:bg-rose-100" type="button">Remove</button>
                  </td>
                </tr>
              `).join("")}
              ${sched.length === 0 ? `
                <tr><td colspan="4" class="px-3 py-6 text-center text-sm text-slate-500">No bands yet. Add one.</td></tr>
              ` : ""}
            </tbody>
          </table>
        </div>
        <div class="mt-3 text-xs text-slate-500">Tip: yearly resets = 12-month bands (1‚Äì12, 13‚Äì24, ...)</div>
      </div>
    `;
  }

  // -----------------------
  // Render
  // -----------------------
  function metricCard(label, value, gradient){
    return `
      <div class="rounded-3xl bg-gradient-to-br ${gradient} p-[1px]">
        <div class="rounded-3xl bg-white p-4">
          <div class="text-xs font-extrabold text-slate-600">${label}</div>
          <div class="mt-2 text-2xl font-black tracking-tight">${value}</div>
        </div>
      </div>
    `;
  }

  function setValue(id, value){
    const el = document.getElementById(id);
    if (el) el.value = value;
  }

  function setMoneyValue(id, value, currency){
    const el = document.getElementById(id);
    if (!el) return;
    const maxDec = (currency === "VND") ? 0 : 2;
    el.value = formatNumberInput(Number(value) || 0, maxDec);
  }

  function onCommit(id, fn){
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", (e) => fn(e.target.value));
    el.addEventListener("blur", (e) => fn(e.target.value));
  }

  function onInput(id, fn){
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", (e) => fn(e.target.value));
    el.addEventListener("change", (e) => fn(e.target.value));
  }

  function setCurrencyControls(selectId, customId){
    const sel = document.getElementById(selectId);
    const custom = document.getElementById(customId);
    if (!sel || !custom) return;

    sel.value = state.inputs.currency;
    custom.value = state.inputs.customCurrencyCode || "";
    custom.classList.toggle("hidden", state.inputs.currency !== "CUSTOM");

    sel.onchange = () => {
      state.inputs.currency = sel.value;
      render();
    };

    custom.oninput = () => {
      state.inputs.customCurrencyCode = (custom.value || "").toUpperCase();
      render();
    };
  }

  function wireToggle(id, checked, onChange){
    const btn = document.getElementById(id);
    if (!btn) return;
    paintToggle(btn, checked);
    btn.onclick = () => onChange(!checked);
  }

  function renderCharts(balanceData, yearlyInterestData, money){
    const balanceCanvas = document.getElementById("balanceChart");
    const interestCanvas = document.getElementById("interestChart");
    if (!balanceCanvas || !interestCanvas) return;

    if (charts.balance) charts.balance.destroy();
    if (charts.interest) charts.interest.destroy();

    charts.balance = new Chart(balanceCanvas, {
      type: "line",
      data: {
        labels: balanceData.map(d => d.date),
        datasets: [{
          label: "Balance",
          data: balanceData.map(d => d.balance),
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${money(Number(ctx.parsed.y))}` } },
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { ticks: { callback: (v) => money(Number(v)) }, grid: { drawBorder: false } }
        }
      }
    });

    charts.interest = new Chart(interestCanvas, {
      type: "bar",
      data: {
        labels: yearlyInterestData.map(d => String(d.year)),
        datasets: [{ label: "Interest", data: yearlyInterestData.map(d => d.interest), borderWidth: 0 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${money(Number(ctx.parsed.y))}` } },
          legend: { display: false }
        },
        scales: {
          y: { ticks: { callback: (v) => money(Number(v)) }, grid: { drawBorder: false } }
        }
      }
    });
  }

  function render(){
    const scheduleSel = state.inputs.scenario === "A" ? state.scheduleA : state.scheduleB;
    const money = makeMoneyFormatter(state.inputs.currency, state.inputs.customCurrencyCode);

    const { rows: rowsSel, nTotal, missingCoverageFromMonth } = buildAmortization(state.inputs, scheduleSel);
    const rowsA = buildAmortization({ ...state.inputs, scenario:"A" }, state.scheduleA).rows;
    const rowsB = buildAmortization({ ...state.inputs, scenario:"B" }, state.scheduleB).rows;

    const sumSel = summarize(rowsSel);
    const sumA = summarize(rowsA);
    const sumB = summarize(rowsB);

    const balanceData = balanceSeries(rowsSel);
    const yearlyInterestData = yearlyInterest(rowsSel);

    const jumpFlag = (r) => state.inputs.showPaymentJumps && r.rateChanged && Math.abs(r.paymentJump) >= Math.max(0, state.inputs.jumpThreshold);
    const jumpCount = rowsSel.filter(jumpFlag).length;

    // header pills + warning
    document.getElementById("pillRows").textContent = `Rows: ${rowsSel.length}`;
    document.getElementById("pillCovered").textContent = `Covered: ${rowsSel.length}/${nTotal}`;
    document.getElementById("pillJumps").textContent = `Jumps: ${jumpCount}`;
    pill(document.getElementById("pillJumps"), jumpCount > 0 ? "amber" : "green");

    const warn = document.getElementById("coverageWarning");
    if (missingCoverageFromMonth){
      warn.classList.remove("hidden");
      document.getElementById("warnScenario").textContent = state.inputs.scenario;
      document.getElementById("warnMonth").textContent = missingCoverageFromMonth;
    } else {
      warn.classList.add("hidden");
    }

    board.innerHTML = "";

    const inputsHTML = `
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
        ${inputField("Principal","loan amount", moneyInput("principal","currency_p","customCurrencyCode_p"))}
        ${inputField("Start date","YYYY-MM-DD", textInput("startDateISO","date"))}
        ${inputField("Term","years or months", termInput("termValue","termUnit"))}

        ${inputField("Payments / year","12 for monthly", textInput("paymentsPerYear","number","1","1"))}
        ${inputField("Extra payment / month","after grace", moneyInput("extraPaymentMonthly","currency_e","customCurrencyCode_e"))}
        ${inputField("Scenario","", selectInput("scenario", [
          {value:"A", label:"A"},
          {value:"B", label:"B"},
        ]))}

        <div class="md:col-span-3">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs text-slate-600">
            Money fields format with <b>comma</b> thousands and <b>dot</b> decimals after you leave the field.
          </div>
        </div>
      </div>
    `;

    const graceHTML = `
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div class="flex flex-col gap-3">
          ${toggleButton("graceEnabled","Enable grace period")}
          ${inputField("Grace type","", selectInput("graceType", [
            {value:"interest_only", label:"interest_only"},
            {value:"full", label:"full"},
          ]))}
          ${inputField("Grace months","", textInput("graceMonths","number","1","0"))}
          ${toggleButton("capitalizeFullGraceInterest","Capitalize interest (full grace)")}
        </div>
        <div class="flex flex-col gap-3">
          ${toggleButton("showPaymentJumps","Enable payment jump flagging")}
          ${inputField("Jump threshold","", moneyInput("jumpThreshold","currency_j","customCurrencyCode_j"))}
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
            <div class="font-extrabold">How jump works</div>
            <div class="mt-1 text-xs text-slate-600">A row is tagged <b>jump</b> only when the interest rate changes and |Œîpayment| ‚â• threshold.</div>
            <div class="mt-2 flex flex-wrap gap-2">
              <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${jumpCount>0?"bg-amber-100 text-amber-900 ring-amber-200":"bg-emerald-100 text-emerald-900 ring-emerald-200"}">Flagged: ${jumpCount}</span>
              <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Selected: ${state.inputs.scenario}</span>
            </div>
          </div>
        </div>
      </div>
    `;

    const metricsHTML = `
      <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
        ${metricCard("Total interest", money(sumSel.totalInterest), "from-fuchsia-600 to-indigo-600")}
        ${metricCard("Total paid", money(sumSel.totalPaid), "from-cyan-500 to-indigo-600")}
        ${metricCard("Max payment", money(sumSel.maxPayment), "from-amber-500 to-fuchsia-600")}
        ${metricCard("Payoff date", sumSel.payoffDate || "‚Äî", "from-emerald-500 to-cyan-500")}
      </div>
    `;

    const chartsHTML = `
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
        <div class="rounded-3xl border border-slate-200 bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold">Balance over time</div>
              <div class="text-xs text-slate-500">End balance each month</div>
            </div>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-indigo-100 text-indigo-800 ring-indigo-200">Scenario ${state.inputs.scenario}</span>
          </div>
          <div class="mt-3 h-64"><canvas id="balanceChart"></canvas></div>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-white p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold">Interest per year</div>
              <div class="text-xs text-slate-500">Sum of interest by calendar year</div>
            </div>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-cyan-100 text-cyan-900 ring-cyan-200">Trend</span>
          </div>
          <div class="mt-3 h-64"><canvas id="interestChart"></canvas></div>
        </div>
      </div>
    `;

    const compareHTML = `
      <div class="mb-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
        <div class="font-extrabold text-slate-900">What are Scenario A & B?</div>
        <p class="mt-1 text-xs text-slate-600">
          <b>Scenario A</b> and <b>Scenario B</b> use the <i>same loan inputs</i> (principal, term, grace rules, extra payment),
          but apply <i>different interest-rate schedules</i>. This lets you compare two possible bank deals or rate paths
          side by side without re-entering data.
        </p>
        <ul class="mt-2 list-disc pl-5 text-xs text-slate-600 space-y-1">
          <li><b>Scenario A</b>: Often used as a <i>baseline</i> (e.g. current bank offer or conservative forecast).</li>
          <li><b>Scenario B</b>: Often used as an <i>alternative</i> (e.g. another bank, renegotiated rates, or optimistic path).</li>
          <li>You can freely edit the rate bands for each scenario below.</li>
          <li>The selector in <b>Inputs ‚Üí Scenario</b> controls which scenario drives the charts and repayment table.</li>
        </ul>
      </div>
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
        <div class="lg:col-span-2 overflow-auto rounded-3xl border border-slate-200">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50">
              <tr class="text-left text-xs font-extrabold uppercase tracking-widest text-slate-500">
                <th class="px-3 py-2">Metric</th>
                <th class="px-3 py-2">A</th>
                <th class="px-3 py-2">B</th>
              </tr>
            </thead>
            <tbody>
              ${[
                ["Total interest", money(sumA.totalInterest), money(sumB.totalInterest)],
                ["Total paid", money(sumA.totalPaid), money(sumB.totalPaid)],
                ["Max payment", money(sumA.maxPayment), money(sumB.maxPayment)],
                ["Payoff date", sumA.payoffDate || "‚Äî", sumB.payoffDate || "‚Äî"],
                ["Rate changes", String(sumA.rateChangeCount), String(sumB.rateChangeCount)],
              ].map((row, idx) => `
                <tr class="${idx%2 ? "bg-white" : "bg-slate-50/30"}">
                  <td class="px-3 py-2 font-bold text-slate-800">${row[0]}</td>
                  <td class="px-3 py-2">${row[1]}</td>
                  <td class="px-3 py-2">${row[2]}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-sm font-extrabold">Quick badges</div>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${state.inputs.scenario==="A"?"bg-indigo-100 text-indigo-800 ring-indigo-200":"bg-slate-100 text-slate-700 ring-slate-200"}">Selected A</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${state.inputs.scenario==="B"?"bg-indigo-100 text-indigo-800 ring-indigo-200":"bg-slate-100 text-slate-700 ring-slate-200"}">Selected B</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${jumpCount>0?"bg-amber-100 text-amber-900 ring-amber-200":"bg-emerald-100 text-emerald-900 ring-emerald-200"}">Flagged jumps: ${jumpCount}</span>
          </div>
          <div class="mt-3 text-xs text-slate-600">Tip: collapse schedules if you only want to focus on results.</div>
        </div>
      </div>
    `;

    const scheduleAHTML = renderSchedulesTable("A");
    const scheduleBHTML = renderSchedulesTable("B");

    const rightTable = `
      <div class="flex flex-wrap items-center gap-2">
        <button id="exportCSV" class="rounded-2xl bg-gradient-to-r from-fuchsia-600 to-indigo-600 px-3 py-2 text-xs font-extrabold text-white shadow hover:opacity-95" type="button">
          <span class="inline-flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-white">
              <path d="M12 3v10m0 0 4-4m-4 4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M4 17v3h16v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Export CSV
          </span>
        </button>
      </div>
    `;

    const tableHTML = `
      <div>
        <div class="mb-3 flex flex-wrap items-center gap-2">
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Rates = decimals</span>
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Re-amortize monthly</span>
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${jumpCount>0?"bg-amber-100 text-amber-900 ring-amber-200":"bg-emerald-100 text-emerald-900 ring-emerald-200"}">Flagged: ${jumpCount}</span>
        </div>

        <div class="rounded-3xl border border-slate-200 overflow-hidden">
          <div class="max-h-[520px] overflow-y-auto overflow-x-auto no-scrollbar">
            <table class="min-w-full text-sm">
            <thead class="sticky top-0 bg-slate-50">
              <tr class="text-left text-xs font-extrabold uppercase tracking-widest text-slate-500">
                <th class="px-3 py-2">#</th>
                <th class="px-3 py-2">Date</th>
                <th class="px-3 py-2">Rate</th>
                <th class="px-3 py-2 text-right">Begin</th>
                <th class="px-3 py-2 text-right">Payment</th>
                <th class="px-3 py-2 text-right">Interest</th>
                <th class="px-3 py-2 text-right">Principal</th>
                <th class="px-3 py-2 text-right">Extra</th>
                <th class="px-3 py-2 text-right">End</th>
                <th class="px-3 py-2">Flags</th>
              </tr>
            </thead>
            <tbody>
              ${rowsSel.length ? rowsSel.map((r, idx) => {
                const flagged = jumpFlag(r);
                const zebra = idx % 2 === 1;
                const rowBg = flagged ? "bg-amber-50" : (zebra ? "bg-white" : "bg-slate-50/30");
                return `
                  <tr class="border-t border-slate-100 ${rowBg}">
                    <td class="px-3 py-2 font-bold text-slate-800">${r.period}</td>
                    <td class="px-3 py-2 text-slate-700">${r.dateISO}</td>
                    <td class="px-3 py-2">
                      <div class="flex flex-wrap items-center gap-2">
                        <span class="font-bold text-slate-800">${formatPct(r.annualRate)}</span>
                        ${r.rateChanged ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-amber-100 text-amber-900 ring-amber-200">rate</span>` : ""}
                      </div>
                    </td>
                    <td class="px-3 py-2 text-right tabular">${money(r.beginBalance)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.payment)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.interest)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.principal)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.extra)}</td>
                    <td class="px-3 py-2 text-right tabular">${money(r.endBalance)}</td>
                    <td class="px-3 py-2">
                      <div class="flex flex-wrap gap-2">
                        ${r.note ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">${r.note}</span>` : ""}
                        ${flagged ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-amber-100 text-amber-900 ring-amber-200">jump</span>` : ""}
                        ${state.inputs.showPaymentJumps && r.rateChanged ? `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">Œî ${money(r.paymentJump)}</span>` : ""}
                      </div>
                    </td>
                  </tr>
                `;
              }).join("") : `
                <tr>
                  <td colspan="10" class="px-3 py-10 text-center text-sm text-slate-500">Nothing to show yet. Add rate bands starting from month 1.</td>
                </tr>
              `}
            </tbody>
          </table>
          </div>
        </div>

        <div class="mt-3 text-xs text-slate-500">Showing ~12 rows at a time (scroll for more). Payment jumps are flagged only when the rate changes and |Œîpayment| ‚â• your threshold.</div>
      </div>
    `;

    const sections = {
      inputs: sectionShell("inputs", inputsHTML),
      grace: sectionShell("grace", graceHTML),
      metrics: sectionShell("metrics", metricsHTML),
      charts: sectionShell("charts", chartsHTML),
      compare: sectionShell("compare", compareHTML),
      scheduleA: sectionShell("scheduleA", scheduleAHTML),
      scheduleB: sectionShell("scheduleB", scheduleBHTML),
      table: sectionShell("table", tableHTML, rightTable),
    };

    layout.order.forEach(id => {
      if (layout.visible?.[id]) board.appendChild(sections[id]);
    });

    // Wire inputs
    setMoneyValue("principal", state.inputs.principal, state.inputs.currency);
    setCurrencyControls("currency_p","customCurrencyCode_p");
    setValue("startDateISO", state.inputs.startDateISO);
    setValue("termValue", state.inputs.termValue);
    setValue("termUnit", state.inputs.termUnit);
    setValue("paymentsPerYear", state.inputs.paymentsPerYear);
    setMoneyValue("extraPaymentMonthly", state.inputs.extraPaymentMonthly, state.inputs.currency);
    setCurrencyControls("currency_e","customCurrencyCode_e");
    setValue("scenario", state.inputs.scenario);

    onCommit("principal", (v)=>{ state.inputs.principal = Math.max(0, parseNumberInput(v)); render(); });
    onInput("startDateISO", (v)=>{ state.inputs.startDateISO = v || state.inputs.startDateISO; render(); });

    onInput("termValue", (v)=>{
      const n = Number(v)||1;
      if (state.inputs.termUnit === "months") state.inputs.termValue = clamp(Math.floor(n), 1, 360);
      else state.inputs.termValue = clamp(n, 1, 30);
      render();
    });

    onInput("termUnit", (u)=>{
      state.inputs.termUnit = (u === "months") ? "months" : "years";
      if (state.inputs.termUnit === "months") state.inputs.termValue = clamp(Math.floor(state.inputs.termValue||1), 1, 360);
      else state.inputs.termValue = clamp(Number(state.inputs.termValue||1), 1, 30);
      render();
    });

    onInput("paymentsPerYear", (v)=>{ state.inputs.paymentsPerYear = clamp(Number(v)||12, 1, 365); render(); });
    onCommit("extraPaymentMonthly", (v)=>{ state.inputs.extraPaymentMonthly = Math.max(0, parseNumberInput(v)); render(); });
    onInput("scenario", (v)=>{ state.inputs.scenario = v === "B" ? "B" : "A"; render(); });

    // Grace + jumps
    wireToggle("graceEnabled", state.inputs.graceEnabled, (nv)=>{ state.inputs.graceEnabled = nv; render(); });
    setValue("graceType", state.inputs.graceType);
    setValue("graceMonths", state.inputs.graceMonths);
    onInput("graceType", (v)=>{ state.inputs.graceType = v; render(); });
    onInput("graceMonths", (v)=>{ state.inputs.graceMonths = Math.max(0, Math.floor(Number(v)||0)); render(); });
    wireToggle("capitalizeFullGraceInterest", state.inputs.capitalizeFullGraceInterest, (nv)=>{ state.inputs.capitalizeFullGraceInterest = nv; render(); });

    wireToggle("showPaymentJumps", state.inputs.showPaymentJumps, (nv)=>{ state.inputs.showPaymentJumps = nv; render(); });
    setMoneyValue("jumpThreshold", state.inputs.jumpThreshold, state.inputs.currency);
    setCurrencyControls("currency_j","customCurrencyCode_j");
    onCommit("jumpThreshold", (v)=>{ state.inputs.jumpThreshold = Math.max(0, parseNumberInput(v)); render(); });

    // Schedules
    document.querySelectorAll("[data-add-band]").forEach(btn => {
      btn.onclick = () => {
        const which = btn.getAttribute("data-add-band");
        const target = which === "A" ? normalizeSchedule(state.scheduleA) : normalizeSchedule(state.scheduleB);
        const last = target[target.length-1];
        const start = last ? last.endMonth + 1 : 1;
        target.push({ startMonth: start, endMonth: start + 11, annualRate: last ? last.annualRate : 0.085 });
        if (which === "A") state.scheduleA = target; else state.scheduleB = target;
        render();
      };
    });

    document.querySelectorAll("[data-auto-bands]").forEach(btn => {
      btn.onclick = () => {
        const which = btn.getAttribute("data-auto-bands");
        autoYearlyBands(which);
        render();
      };
    });

    document.querySelectorAll("[data-remove-band]").forEach(btn => {
      btn.onclick = () => {
        const which = btn.getAttribute("data-remove-band");
        const idx = Number(btn.getAttribute("data-idx"));
        const target = normalizeSchedule(which === "A" ? state.scheduleA : state.scheduleB);
        target.splice(idx, 1);
        if (which === "A") state.scheduleA = target; else state.scheduleB = target;
        render();
      };
    });

    document.querySelectorAll("input[data-sched]").forEach(inp => {
      inp.oninput = (e) => {
        const which = inp.getAttribute("data-sched");
        const idx = Number(inp.getAttribute("data-idx"));
        const key = inp.getAttribute("data-key");
        const target = normalizeSchedule(which === "A" ? state.scheduleA : state.scheduleB);
        const val = (e.target.value === "") ? "" : Number(e.target.value);
        if (key === "startMonth") target[idx].startMonth = Math.max(1, Math.floor(val||1));
        if (key === "endMonth") target[idx].endMonth = Math.max(1, Math.floor(val||1));
        if (key === "annualRate") target[idx].annualRate = Number.isFinite(val) ? val : 0;
        if (which === "A") state.scheduleA = target; else state.scheduleB = target;
        render();
      };
    });

    // Export
    const exp = document.getElementById("exportCSV");
    if (exp) exp.onclick = () => downloadCSV(`amort_${state.inputs.scenario}.csv`, rowsSel);

    // Charts
    renderCharts(balanceData, yearlyInterestData, money);
  }

  // -----------------------
  // Pointer-based Drag & Drop (robust)
  // -----------------------
  const dnd = {
    draggingId: null,
    draggingEl: null,
    placeholder: null,
    ghost: null,
    startX: 0,
    startY: 0,
    offsetX: 0,
    offsetY: 0,
    activePointerId: null,
  };

  const cleanupDnD = () => {
    if (dnd.draggingEl) dnd.draggingEl.classList.remove("dragging");
    document.querySelectorAll("[data-id]").forEach(c => c.classList.remove("drop-hint"));

    if (dnd.placeholder && dnd.placeholder.parentNode) dnd.placeholder.parentNode.removeChild(dnd.placeholder);
    if (dnd.ghost && dnd.ghost.parentNode) dnd.ghost.parentNode.removeChild(dnd.ghost);

    dnd.draggingId = null;
    dnd.draggingEl = null;
    dnd.placeholder = null;
    dnd.ghost = null;
    dnd.activePointerId = null;

    // save order (preserve hidden section positions)
    const oldOrder = Array.isArray(layout.order) ? [...layout.order] : [...DEFAULT_ORDER];
    const newVisibleOrder = Array.from(board.querySelectorAll("[data-id]")).map(x => x.dataset.id);

    // Replace visible ids in the old order with the new visible order, keeping hidden ids in place.
    const visSet = new Set(newVisibleOrder);
    const queue = [...newVisibleOrder];
    const merged = oldOrder.map(id => (visSet.has(id) ? queue.shift() : id));

    // If something went weird (shouldn't), fall back to merged+missing.
    const known = new Set(DEFAULT_ORDER);
    const cleaned = merged.filter(id => known.has(id));
    DEFAULT_ORDER.forEach(id => { if(!cleaned.includes(id)) cleaned.push(id); });

    layout.order = cleaned;
    saveLayout(layout.order, layout.collapsed, layout.visible);
  };

  const makeGhost = (el) => {
    const rect = el.getBoundingClientRect();
    const g = el.cloneNode(true);
    g.classList.add("ghost");
    g.style.width = rect.width + "px";
    g.style.left = rect.left + "px";
    g.style.top = rect.top + "px";
    g.style.opacity = "0.92";
    g.style.boxShadow = "0 20px 40px rgba(15,23,42,.18)";
    g.style.borderRadius = "28px";
    document.body.appendChild(g);
    return g;
  };

  const makePlaceholder = (el) => {
    const rect = el.getBoundingClientRect();
    const p = document.createElement("div");
    p.className = "placeholder";
    p.style.height = rect.height + "px";
    return p;
  };

  const updateGhostPos = (clientX, clientY) => {
    if (!dnd.ghost) return;
    const x = clientX - dnd.offsetX;
    const y = clientY - dnd.offsetY;
    dnd.ghost.style.left = x + "px";
    dnd.ghost.style.top = y + "px";
  };

  const getDropTarget = (clientX, clientY) => {
    const el = document.elementFromPoint(clientX, clientY);
    if (!el) return null;
    const target = el.closest("[data-id]");
    if (!target || target === dnd.draggingEl) return null;
    return target;
  };

  const placePlaceholder = (overEl, clientY) => {
    if (!overEl || !dnd.placeholder) return;

    document.querySelectorAll("[data-id]").forEach(c => c.classList.remove("drop-hint"));
    overEl.classList.add("drop-hint");

    const rect = overEl.getBoundingClientRect();
    const before = (clientY - rect.top) < rect.height / 2;

    if (before) {
      if (overEl.parentNode) overEl.parentNode.insertBefore(dnd.placeholder, overEl);
    } else {
      if (overEl.parentNode) overEl.parentNode.insertBefore(dnd.placeholder, overEl.nextSibling);
    }
  };

  // Delegate pointer events from the board so we don't rebind on each render
  board.addEventListener("pointerdown", (e) => {
    const handle = e.target.closest(".handle");
    if (!handle) return;

    const wrap = handle.closest("[data-id]");
    if (!wrap) return;

    // prevent focusing inputs while dragging
    e.preventDefault();

    dnd.draggingEl = wrap;
    dnd.draggingId = wrap.dataset.id;
    dnd.activePointerId = e.pointerId;

    const rect = wrap.getBoundingClientRect();
    dnd.offsetX = e.clientX - rect.left;
    dnd.offsetY = e.clientY - rect.top;

    wrap.classList.add("dragging");
    dnd.placeholder = makePlaceholder(wrap);
    wrap.parentNode.insertBefore(dnd.placeholder, wrap.nextSibling);

    dnd.ghost = makeGhost(wrap);
    updateGhostPos(e.clientX, e.clientY);

    handle.setPointerCapture?.(e.pointerId);
  });

  board.addEventListener("pointermove", (e) => {
    if (!dnd.draggingEl || dnd.activePointerId !== e.pointerId) return;
    updateGhostPos(e.clientX, e.clientY);

    const over = getDropTarget(e.clientX, e.clientY);
    if (over) placePlaceholder(over, e.clientY);
  });

  board.addEventListener("pointerup", (e) => {
    if (!dnd.draggingEl || dnd.activePointerId !== e.pointerId) return;

    // drop: insert element at placeholder
    if (dnd.placeholder && dnd.placeholder.parentNode) {
      dnd.placeholder.parentNode.insertBefore(dnd.draggingEl, dnd.placeholder);
    }

    cleanupDnD();
  });

  board.addEventListener("pointercancel", (e) => {
    if (!dnd.draggingEl || dnd.activePointerId !== e.pointerId) return;
    cleanupDnD();
  });

  // -----------------------
  // Header buttons
  // -----------------------
  document.getElementById("resetLayoutBtn").addEventListener("click", () => {
    try {
      localStorage.removeItem(LS_ORDER);
      localStorage.removeItem(LS_COLLAPSED);
      localStorage.removeItem(LS_VISIBLE);
    } catch {}
    layout = loadLayout();
    render();
  });

  // -----------------------
  // Tests (console)
  // -----------------------
  (function runTests(){
    const assert = (name, cond) => {
      if (!cond) console.error("‚ùå Test failed:", name);
      else console.log("‚úÖ", name);
    };

    assert("formatNumberInput uses comma grouping", formatNumberInput(2000, 0) === "2,000");
    assert("parseNumberInput strips commas", parseNumberInput("2,000") === 2000);
    assert("term years clamp to 30", getTermPeriods({ termUnit:"years", termValue: 50, paymentsPerYear: 12 }) === 360);
    assert("term months clamp to 360", getTermPeriods({ termUnit:"months", termValue: 999, paymentsPerYear: 12 }) === 360);
  })();

  // initial render
  render();
</script>
</body>
</html>
